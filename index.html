<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarStock</title>
    <link rel="icon" href="barstock-icon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="barstock-styles.css">
    <script src="api.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <h1>BarStock</h1>
                <div class="header-actions">
                    <!-- Cocktail buttons -->
                    <div id="cocktail-buttons" class="header-btn-group">
                        <button class="header-btn" onclick="openImportFromUrlModal()" title="Import Recipe from Website">Import Online</button>
                        <button class="header-btn" onclick="document.getElementById('cocktailsImportInput').click()" title="Import Cocktails from File">Import</button>
                        <input type="file" id="cocktailsImportInput" accept=".json" onchange="importCocktailsFromFile(event)" style="display: none;">
                        <button class="header-btn" onclick="exportCocktails()" title="Export Cocktails">Export</button>
                    </div>
                    
                    <!-- Inventory buttons -->
                    <div id="inventory-buttons" class="header-btn-group" style="display: none;">
                        <button class="header-btn" onclick="document.getElementById('inventoryImportInput').click()" title="Import Inventory">Import</button>
                        <input type="file" id="inventoryImportInput" accept=".json" onchange="importInventoryFromFile(event)" style="display: none;">
                        <button class="header-btn" onclick="exportInventory()" title="Export Inventory">Export</button>
                    </div>
                    
                    <!-- Theme toggle (always visible) -->
                    <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Cocktails Section -->
        <div id="cocktails-section" class="tab-content">
            <div style="margin: 8px 0; display: flex; gap: 8px; align-items: center;">
                <div class="search-container">
                    <input type="text" class="search-box" id="searchBox" placeholder="Search cocktails...">
                    <button class="search-clear hidden" id="searchClear" onclick="clearSearch('searchBox')">‚úï</button>
                </div>
                <button class="btn-add" onclick="showAddCocktailForm()" style="padding: 0 15px; white-space: nowrap;">
                    +
                </button>
            </div>

            <div>
                <button class="filter-toggle-btn collapsed" id="cocktailFilterBtn" onclick="toggleFilters()">
                    <span>Filters</span>
                    <span class="arrow">‚ñº</span>
                </button>
            </div>

            <div class="filters collapsed" id="filterContent">
                <div class="filter-content">
                    <div class="filter-group" style="margin-top: 0px;">
                        <label>Category</label>
                        <div class="filter-buttons" id="categoryFilters"></div>
                    </div>

                    <div class="filter-group">
                        <label>Base Spirit</label>
                        <div class="filter-buttons" id="spiritFilters"></div>
                    </div>

                    <div class="filter-toggle">
                        <label class="toggle-switch">
                            <input type="checkbox" id="canMakeToggle">
                            <span class="slider"></span>
                        </label>
                        <label for="canMakeToggle" style="margin: 0; font-weight: normal; font-size: 0.9rem;">Show only cocktails I can make</label>
                    </div>
                </div>
            </div>

            <div class="cocktail-grid" id="cocktailGrid"></div>
        </div>

        <!-- Add Cocktail Modal (opened by + on Cocktails tab) -->
        <div class="add-cocktail-modal" id="addCocktailModal">
            <div class="add-cocktail-modal-content">
                <div id="add-cocktail-section" class="add-item-form">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2>Create New Cocktail</h2>
                        <button class="modal-close" onclick="cancelCocktailEdit()" style="position: static; margin: 0;">√ó</button>
                    </div>
                
                <div class="filter-group" style="margin-bottom: 8px;">
                    <label>Import Recipe from URL</label>
                    <div class="form-row">
                        <input type="text" class="form-input" id="importUrl" placeholder="Paste recipe URL to auto-fill (optional)" style="flex: 1;">
                        <button class="btn btn-pill btn-pill-center" onclick="importRecipe()">Import</button>
                    </div>
                </div>

                <div class="filter-group">
                    <label>Fill Recipe</label>
                </div>

                <div class="form-row">
                    <input type="text" class="form-input" id="cocktailName" placeholder="Cocktail name" style="flex: 2;">
                    <input type="text" class="form-input" id="cocktailImage" placeholder="Image URL (optional)">
                </div>
                <div class="form-row">
                    <select class="form-select" id="cocktailCategory">
                        <option value="">Select category...</option>
                        <option value="Classic">Classic</option>
                        <option value="Modern">Modern</option>
                        <option value="Refreshing">Refreshing</option>
                        <option value="Bitter">Bitter</option>
                        <option value="Sweet">Sweet</option>
                        <option value="Sour">Sour</option>
                        <option value="Tropical">Tropical</option>
                    </select>
                    <select class="form-select" id="cocktailSpirit">
                        <option value="">Select base spirit...</option>
                        <option value="Vodka">Vodka</option>
                        <option value="Gin">Gin</option>
                        <option value="Rum">Rum</option>
                        <option value="Tequila">Tequila</option>
                        <option value="Whiskey">Whiskey</option>
                        <option value="Bourbon">Bourbon</option>
                        <option value="Brandy">Brandy</option>
                        <option value="Mezcal">Mezcal</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="text" class="form-input" id="cocktailSource" placeholder="Source (optional)">
                </div>
                <div class="form-row">
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <input type="color" id="cocktailColor" class="color-pick-pill">
                        <button class="btn btn-pill" onclick="useSpiritColor()">Match Spirit</button>
                        <button class="btn btn-pill" onclick="randomizeColor()">Random</button>
                    </div>
                </div>

                <div class="section-header">
                    <h3>Ingredients</h3>
                    <button class="btn btn-pill btn-section-add" onclick="addIngredientRow()" title="Add Ingredient">+</button>
                </div>
                <div id="ingredientsContainer">
                    <div class="form-row ingredient-row">
                        <input type="text" class="form-input" placeholder="Ingredient name" data-ingredient-name>
                        <input type="number" class="form-input" placeholder="Qty" data-ingredient-amount style="max-width: 80px;">
                        <select class="form-select ingredient-unit" data-ingredient-unit>
                            <option value="">Unit</option>
                            <option value="oz">oz</option>
                            <option value="ml">ml</option>
                            <option value="cl">cl</option>
                            <option value="dash">dash</option>
                            <option value="splash">splash</option>
                            <option value="drop">drop</option>
                            <option value="tsp">tsp</option>
                            <option value="tbsp">tbsp</option>
                            <option value="wedge">wedge</option>
                            <option value="piece">piece</option>
                        </select>
                        <button class="btn btn-pill" onclick="removeIngredientRow(this)">‚úï</button>
                    </div>
                </div>

                <div class="section-header">
                    <h3>Instructions</h3>
                    <button class="btn btn-pill btn-section-add" onclick="addStepRow()" title="Add Step">+</button>
                </div>
                <div id="stepsContainer">
                    <div class="form-row step-row">
                        <input type="text" class="form-input" placeholder="Step description" data-step style="flex: 1;">
                        <button class="btn btn-pill" onclick="removeStepRow(this)">‚úï</button>
                    </div>
                </div>

                <div class="form-row" style="margin-top: 20px; gap: 10px;">
                    <button class="btn btn-pill btn-pill-center" onclick="saveCocktail()" style="flex: 1;">Save Cocktail</button>
                </div>
                </div>
            </div>
        </div>

        <!-- Inventory Section -->
        <div id="inventory-section" class="inventory-section tab-content">
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                <div style="flex:1;">
                    <div class="search-container">
                        <input type="text" class="search-box" id="inventorySearchBox" placeholder="Search items...">
                        <button class="search-clear hidden" id="inventoryClear" onclick="clearSearch('inventorySearchBox')">‚úï</button>
                    </div>
                </div>
                <div>
                    <button class="btn-add" onclick="openAddInventoryModal()" title="Add Item">+</button>
                </div>
            </div>

            <div>
                <button class="filter-toggle-btn collapsed" id="inventoryFilterBtn" onclick="toggleInventoryFilters()">
                    <span>Filters</span>
                    <span class="arrow">‚ñº</span>
                </button>
                
                <!-- Inventory Filters -->
                <div class="filters collapsed" style="margin-top: 0px;" id="inventoryFilterContent">
                    
                    <div class="filter-content">
                        
                        <div class="filter-group">
                            <label>Category</label>
                            <div class="filter-buttons" id="inventoryCategoryFilters"></div>
                        </div>

                        <div class="filter-group filter-range-row">
                            <label>Volume Range (ml)</label>
                            <div class="filter-minmax">
                                <input type="number" class="form-input" id="volumeMin" placeholder="Min" min="0" step="1">
                                <input type="number" class="form-input" id="volumeMax" placeholder="Max" min="0" step="1">
                            </div>
                        </div>

                        <div class="filter-group filter-range-row">
                            <label>ABV Range (%)</label>
                            <div class="filter-minmax">
                                <input type="number" class="form-input" id="abvMin" placeholder="Min" min="0" max="100" step="0.1">
                                <input type="number" class="form-input" id="abvMax" placeholder="Max" min="0" max="100" step="0.1">
                            </div>
                        </div>

                        <div class="filter-group filter-range-row">
                            <label>Sugar Content Range (g/L)</label>
                            <div class="filter-minmax">
                                <input type="number" class="form-input" id="sugarMin" placeholder="Min" min="0" step="0.1">
                                <input type="number" class="form-input" id="sugarMax" placeholder="Max" min="0" step="0.1">
                            </div>
                        </div>

                        <div class="filter-group filter-range-row">
                            <label>Year Range</label>
                            <div class="filter-minmax">
                                <input type="number" class="form-input" id="yearMin" placeholder="Min" min="1900" max="2030">
                                <input type="number" class="form-input" id="yearMax" placeholder="Max" min="1900" max="2030">
                            </div>
                        </div>

                        <div class="filter-group">
                            <label>Brand</label>
                            <div class="filter-buttons" id="inventoryBrandFilters"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="inventory-list" style="margin-top: 8px;">
                <h2>Bar Inventory (<span id="inventoryCount">0</span> items)</h2>
                <div class="inventory-grid" id="inventoryGrid"></div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs at Bottom -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('cocktails')">Cocktails</button>
        <button class="nav-tab" onclick="switchTab('inventory')">Inventory</button>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-dialog">
            <div class="spinner"></div>
        </div>
    </div>

    <!-- Add Inventory Modal -->
    <div class="inventory-modal" id="addInventoryModal">
        <div class="inventory-modal-content">
            <button class="modal-close" onclick="closeAddInventoryModal()">√ó</button>
            <h2 style="margin-top: 0;">Add item</h2>
            
            <div id="barcodeResult" style="display: none;"></div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text);">Scan Item Barcode</label>
                <div style="display:flex; gap:8px; align-items:center;">
                    <div class="search-container" style="flex:1;">
                        <input type="text" class="search-box" id="barcodeInput" placeholder="Scan barcode or enter item name..." autofocus>
                        <button class="search-clear hidden" id="barcodeClear" onclick="clearSearch('barcodeInput')">‚úï</button>
                    </div>
                    <div>
                        <button class="btn btn-pill" id="modalScanBtn" onclick="startBarcodeScanner()">Scan</button>
                    </div>
                </div>
            </div>

            <div id="scannerContainer" style="display: none; margin-bottom: 15px;">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas" style="display: none;"></canvas>
                <p style="margin-top: 10px; font-size: 0.9rem; color: var(--text-light); text-align: center;">
                    Position the barcode in the camera view
                </p>
                <button class="btn btn-pill" onclick="stopBarcodeScanner()" style="width: 100%; margin-top: 8px;">Stop Scanning</button>
            </div>

            <div class="form-row">
                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text);">Enter Item Details</label>
                <input type="text" class="form-input" id="itemName" placeholder="Item name" style="flex: 2;">
                <select class="form-select" id="itemCategory">
                    <option value="">Category</option>
                    <option value="Spirit">Spirit</option>
                    <option value="Liqueur">Liqueur</option>
                    <option value="Wine - Red">Wine - Red</option>
                    <option value="Wine - White">Wine - White</option>
                    <option value="Wine - Ros√©">Wine - Ros√©</option>
                    <option value="Wine - Orange">Wine - Orange</option>
                    <option value="Wine - Sparkling">Wine - Sparkling</option>
                    <option value="Wine - Dessert">Wine - Dessert</option>
                    <option value="Mixer">Mixer</option>
                    <option value="Juice">Juice</option>
                    <option value="Syrup">Syrup</option>
                    <option value="Bitters">Bitters</option>
                    <option value="Garnish">Garnish</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-row">
                <input type="text" class="form-input" id="itemBrand" placeholder="Brand (optional)">
                <input type="text" class="form-input" id="itemModel" placeholder="Model/Variant (optional)">
                <input type="number" class="form-input" id="itemYear" placeholder="Year" min="1900" max="2030" style="max-width: 120px;">
                <input type="number" class="form-input" id="itemVolume" placeholder="Volume (ml)" min="0" step="0.1" style="max-width: 150px;">
                <input type="number" class="form-input" id="itemABV" placeholder="ABV %" min="0" max="100" step="0.1" style="max-width: 150px;">
                <input type="number" class="form-input" id="itemSugar" placeholder="Sugar (g/L)" min="0" step="0.1" style="max-width: 150px;">
            </div>
            <div class="form-row" id="itemImageRow" style="display: flex; gap: 8px; align-items:center; flex-wrap: wrap;">
                <label style="width: 100%; font-weight: 600; color: var(--text); margin-bottom: 6px;">Image</label>
                <input type="file" class="form-input" id="itemImageFile" accept="image/*" capture="environment" style="display: none;" onchange="previewItemImage()">
                <button type="button" class="btn btn-pill" onclick="document.getElementById('itemImageFile').click()" style="white-space: nowrap;">Camera/File</button>
                <input type="text" class="form-input" id="itemImage" placeholder="Or enter image URL (optional)" style="flex: 1; min-width: 200px;">
                <button class="btn btn-pill" onclick="previewItemImage()">Preview</button>
            </div>
            <img id="itemImagePreview" src="" alt="" style="display:none; max-width: 120px; margin: 8px 0; border-radius:8px;">

            <div class="form-row" style="margin-top: 20px; gap: 10px;">
                <button class="btn btn-pill btn-pill-center" id="addInventorySubmitBtn" onclick="addInventoryItem()" style="flex: 1;">Add Item</button>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="cocktailModal">
        <div class="modal-content">
            <div style="position: absolute; top: 10px; left: 10px;">
                <button class="btn-edit" id="modalEditBtn" style="display: none;" onclick="editCocktailFromModal()">
                    <img src="https://cdn-icons-png.flaticon.com/128/3917/3917376.png" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px; filter: brightness(0) invert(1);" alt="Edit">
                    Edit
                </button>
            </div>

            <!--<div style="display: flex; justify-content: space-between; align-items: center; position: absolute; top: 10px; right: 10px; gap: 10px;"></div>-->
            <div style="position: absolute; top: 2px; right: 2px;">
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Import from URL Modal -->
    <div class="modal" id="importUrlModal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="closeImportUrlModal()">√ó</button>
            <h2 style="margin-top: 0;">Import Recipe from Website</h2>
            
            <div style="margin-bottom: 20px;">
                <label for="recipeUrl" style="display: block; margin-bottom: 8px; font-weight: 500;">Recipe Website URL</label>
                <input type="text" id="recipeUrl" placeholder="https://example.com/recipe/mojito" 
                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                <small style="display: block; margin-top: 5px; color: var(--text-secondary);">
                    Paste the full URL of a cocktail recipe website
                </small>
            </div>

            <div id="urlImportStatus" style="margin-bottom: 15px; display: none;">
                <div style="padding: 12px; background-color: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; border-radius: 4px;">
                    <span id="urlImportStatusText"></span>
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn btn-pill" onclick="importRecipeFromUrl()" style="flex: 1;">
                    üîó Fetch Recipe
                </button>
                <button class="btn btn-pill" onclick="closeImportUrlModal()" style="flex: 1; background-color: var(--bg-secondary);">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // Cocktail colors for card backgrounds
        const cocktailColors = [
            '#4a5568', '#2d3748', '#718096', '#1a202c', '#2c5282', 
            '#2f855a', '#c05621', '#744210', '#5f370e', '#9c4221'
        ];

        // Spirit-based color palette
        const spiritColors = {
            'Vodka': '#e2e8f0',      // Light grey/clear - represents vodka's clarity
            'Gin': '#86efac',         // Light green - represents botanicals/juniper
            'Rum': '#d97706',         // Amber/golden - represents aged rum
            'Tequila': '#fbbf24',     // Golden yellow - represents agave/reposado
            'Whiskey': '#92400e',     // Deep brown - represents barrel aging
            'Bourbon': '#b45309',     // Rich amber - represents American oak
            'Brandy': '#7c2d12',      // Dark reddish brown - represents grape spirits
            'Mezcal': '#6b7280',      // Smoky grey - represents smoke/agave
            'Other': '#475569'        // Neutral grey - default
        };

        // Sample cocktail data - in production, this would come from a database
        let cocktails = JSON.parse(localStorage.getItem('cocktails')) || [
            {
                id: 1,
                name: "Margarita",
                category: "Classic",
                baseSpirit: "Tequila",
                image: null,
                color: spiritColors['Tequila'],
                ingredients: [
                    { name: "Tequila", amount: "2 oz" },
                    { name: "Lime Juice", amount: "1 oz" },
                    { name: "Triple Sec", amount: "1 oz" },
                    { name: "Salt", amount: "for rim" }
                ],
                steps: [
                    "Rim glass with salt",
                    "Add tequila, lime juice, and triple sec to shaker with ice",
                    "Shake well for 15 seconds",
                    "Strain into salt-rimmed glass over ice",
                    "Garnish with lime wheel"
                ],
                source: "IBA Official Cocktails"
            },
            {
                id: 2,
                name: "Old Fashioned",
                category: "Classic",
                baseSpirit: "Whiskey",
                image: null,
                color: spiritColors['Whiskey'],
                ingredients: [
                    { name: "Bourbon", amount: "2 oz" },
                    { name: "Sugar Cube", amount: "1" },
                    { name: "Angostura Bitters", amount: "2-3 dashes" },
                    { name: "Orange Peel", amount: "1" }
                ],
                steps: [
                    "Place sugar cube in glass",
                    "Add bitters and muddle",
                    "Add bourbon and stir",
                    "Add large ice cube",
                    "Express orange peel over drink and garnish"
                ],
                source: "Classic Cocktail Guide"
            },
            {
                id: 3,
                name: "Mojito",
                category: "Refreshing",
                baseSpirit: "Rum",
                image: null,
                color: spiritColors['Rum'],
                ingredients: [
                    { name: "White Rum", amount: "2 oz" },
                    { name: "Lime Juice", amount: "1 oz" },
                    { name: "Mint Leaves", amount: "8-10" },
                    { name: "Simple Syrup", amount: "0.5 oz" },
                    { name: "Soda Water", amount: "Top" }
                ],
                steps: [
                    "Muddle mint leaves with simple syrup in glass",
                    "Add lime juice and rum",
                    "Fill glass with ice",
                    "Top with soda water",
                    "Stir gently and garnish with mint sprig"
                ],
                source: "Cuban Classics"
            },
            {
                id: 4,
                name: "Negroni",
                category: "Bitter",
                baseSpirit: "Gin",
                image: null,
                color: spiritColors['Gin'],
                ingredients: [
                    { name: "Gin", amount: "1 oz" },
                    { name: "Campari", amount: "1 oz" },
                    { name: "Sweet Vermouth", amount: "1 oz" },
                    { name: "Orange Peel", amount: "1" }
                ],
                steps: [
                    "Add gin, Campari, and vermouth to mixing glass with ice",
                    "Stir for 30 seconds",
                    "Strain into rocks glass over ice",
                    "Express orange peel and garnish"
                ],
                source: "Italian Aperitifs"
            },
            {
                id: 5,
                name: "Espresso Martini",
                category: "Modern",
                baseSpirit: "Vodka",
                image: null,
                color: spiritColors['Vodka'],
                ingredients: [
                    { name: "Vodka", amount: "2 oz" },
                    { name: "Coffee Liqueur", amount: "0.5 oz" },
                    { name: "Fresh Espresso", amount: "1 oz" },
                    { name: "Simple Syrup", amount: "0.25 oz" }
                ],
                steps: [
                    "Add all ingredients to shaker with ice",
                    "Shake vigorously for 15-20 seconds",
                    "Strain into chilled martini glass",
                    "Garnish with coffee beans"
                ],
                source: "Contemporary Cocktails"
            },
            {
                id: 6,
                name: "Moscow Mule",
                category: "Refreshing",
                baseSpirit: "Vodka",
                image: null,
                color: spiritColors['Vodka'],
                ingredients: [
                    { name: "Vodka", amount: "2 oz" },
                    { name: "Lime Juice", amount: "0.5 oz" },
                    { name: "Ginger Beer", amount: "4 oz" },
                    { name: "Lime Wedge", amount: "1" }
                ],
                steps: [
                    "Fill copper mug with ice",
                    "Add vodka and lime juice",
                    "Top with ginger beer",
                    "Stir gently",
                    "Garnish with lime wedge"
                ],
                source: "Modern Classics"
            }
        ];

        // Bar inventory
        let barInventory = JSON.parse(localStorage.getItem('barInventory')) || [];

        // Inventory filters
        let inventoryFilters = {
            category: null,
            brand: null,
            search: '',
            volumeMin: null,
            volumeMax: null,
            abvMin: null,
            abvMax: null,
            sugarMin: null,
            sugarMax: null,
            yearMin: null,
            yearMax: null
        };

        // Get unique categories and spirits
        const categories = [...new Set(cocktails.map(c => c.category))];
        const spirits = [...new Set(cocktails.map(c => c.baseSpirit))];

        let activeFilters = {
            category: null,
            spirit: null,
            canMake: false,
            search: ''
        };

        // Initialize the app
        function init() {
            // Set default year to current year
            document.getElementById('itemYear').value = new Date().getFullYear();
            
            // Set default cocktail color to Vodka (neutral starting point)
            document.getElementById('cocktailColor').value = spiritColors['Vodka'];
            
            renderFilters();
            renderCocktails();
            renderInventoryFilters();
            renderInventory();

            // Event listeners
            document.getElementById('searchBox').addEventListener('input', (e) => {
                activeFilters.search = e.target.value.toLowerCase();
                updateSearchClearButton('searchBox', 'searchClear');
                renderCocktails();
            });

            document.getElementById('canMakeToggle').addEventListener('change', (e) => {
                activeFilters.canMake = e.target.checked;
                renderCocktails();
            });

            // Inventory filter event listeners
            document.getElementById('inventorySearchBox').addEventListener('input', (e) => {
                inventoryFilters.search = e.target.value.toLowerCase();
                updateSearchClearButton('inventorySearchBox', 'inventoryClear');
                renderInventory();
            });

            ['volumeMin', 'volumeMax', 'abvMin', 'abvMax', 'sugarMin', 'sugarMax', 'yearMin', 'yearMax'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    const value = e.target.value;
                    inventoryFilters[id] = value ? parseFloat(value) : null;
                    renderInventory();
                });
            });

            // Initialize header buttons to show cocktail buttons by default
            switchTab('cocktails');
        }

        // Render filter buttons
        function renderFilters() {
            const categoryContainer = document.getElementById('categoryFilters');
            const spiritContainer = document.getElementById('spiritFilters');

            categoryContainer.innerHTML = `
                <button class="filter-btn active" onclick="setFilter('category', null)">All</button>
                ${categories.map(cat => 
                    `<button class="filter-btn" onclick="setFilter('category', '${cat}')">${cat}</button>`
                ).join('')}
            `;

            spiritContainer.innerHTML = `
                <button class="filter-btn active" onclick="setFilter('spirit', null)">All</button>
                ${spirits.map(spirit => 
                    `<button class="filter-btn" onclick="setFilter('spirit', '${spirit}')">${spirit}</button>`
                ).join('')}
            `;
        }

        // Set filter
        function setFilter(type, value) {
            activeFilters[type] = value;
            
            // Update button states
            const container = type === 'category' ? 'categoryFilters' : 'spiritFilters';
            document.querySelectorAll(`#${container} .filter-btn`).forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderCocktails();
        }

        // Check if cocktail can be made
        function canMakeCocktail(cocktail) {
            return cocktail.ingredients.every(ing => 
                barInventory.some(item => 
                    item.name.toLowerCase().includes(ing.name.toLowerCase()) ||
                    ing.name.toLowerCase().includes(item.name.toLowerCase())
                )
            );
        }

        // Filter cocktails
        function filterCocktails() {
            return cocktails.filter(cocktail => {
                // Category filter
                if (activeFilters.category && cocktail.category !== activeFilters.category) {
                    return false;
                }

                // Spirit filter
                if (activeFilters.spirit && cocktail.baseSpirit !== activeFilters.spirit) {
                    return false;
                }

                // Can make filter
                if (activeFilters.canMake && !canMakeCocktail(cocktail)) {
                    return false;
                }

                // Search filter
                if (activeFilters.search) {
                    const searchTerm = activeFilters.search;
                    return cocktail.name.toLowerCase().includes(searchTerm) ||
                           cocktail.ingredients.some(ing => ing.name.toLowerCase().includes(searchTerm));
                }

                return true;
            });
        }

        // Render cocktails
        function renderCocktails() {
            const grid = document.getElementById('cocktailGrid');
            const filtered = filterCocktails();

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-state-icon">üçπ</div>
                        <h3>No cocktails found</h3>
                        <p>Try adjusting your filters</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map(cocktail => {
                const canMake = canMakeCocktail(cocktail);
                const bgColor = cocktail.color || cocktailColors[cocktail.id % cocktailColors.length];
                const hasImage = cocktail.image && cocktail.image.trim() !== '';
                
                return `
                    <div class="cocktail-card">
                        <div class="cocktail-card-image-wrap">
                            <div class="cocktail-image" style="background: ${hasImage ? `url('${cocktail.image}') center/cover` : bgColor};" onclick="openModal(${cocktail.id})">
                                ${!hasImage ? 'üç∏' : ''}
                            </div>
                            <button class="btn-edit btn-edit-card" onclick="event.stopPropagation(); editCocktail(${cocktail.id})">
                                <img src="https://cdn-icons-png.flaticon.com/128/3917/3917376.png" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px; filter: brightness(0) invert(1);" alt="Edit">
                                Edit
                            </button>
                        </div>
                        <div class="cocktail-content" onclick="openModal(${cocktail.id})">
                            <div class="cocktail-header">
                                <h3 class="cocktail-name">${cocktail.name}</h3>
                                <div class="cocktail-actions">
                                    ${canMake ? '<span class="can-make-badge">Can Make!</span>' : ''}
                                </div>
                            </div>
                            <div class="cocktail-tags">
                                <span class="tag category">${cocktail.category}</span>
                                <span class="tag">${cocktail.baseSpirit}</span>
                            </div>
                            <div class="cocktail-preview">
                                ${cocktail.ingredients.slice(0, 3).map(ing => ing.name).join(', ')}
                                ${cocktail.ingredients.length > 3 ? '...' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Open modal
        function openModal(cocktailId) {
            const cocktail = cocktails.find(c => c.id === cocktailId);
            if (!cocktail) return;

            const modal = document.getElementById('cocktailModal');
            const content = document.getElementById('modalContent');
            const bgColor = cocktail.color || cocktailColors[cocktail.id % cocktailColors.length];
            const hasImage = cocktail.image && cocktail.image.trim() !== '';
            
            // Check if source is a URL
            const isUrl = cocktail.source && (cocktail.source.startsWith('http://') || cocktail.source.startsWith('https://'));
            const sourceHtml = isUrl 
                ? `<a href="${cocktail.source}" target="_blank" rel="noopener noreferrer" style="color: var(--secondary); text-decoration: underline;">${cocktail.source}</a>`
                : cocktail.source;

            content.innerHTML = `
                <div class="modal-image" style="background: ${hasImage ? `url('${cocktail.image}') center/cover` : bgColor};">
                    ${!hasImage ? 'üç∏' : ''}
                </div>
                <div class="modal-body">
                    <h2 class="modal-title">${cocktail.name}</h2>
                    <div class="cocktail-tags">
                        <span class="tag category">${cocktail.category}</span>
                        <span class="tag">${cocktail.baseSpirit}</span>
                    </div>

                    <div class="ingredients-list">
                        <h3>Ingredients</h3>
                        ${cocktail.ingredients.map(ing => {
                            const available = barInventory.some(item => 
                                item.name.toLowerCase().includes(ing.name.toLowerCase()) ||
                                ing.name.toLowerCase().includes(item.name.toLowerCase())
                            );
                            const amountDisplay = ing.unit ? `${ing.amount} ${ing.unit}` : ing.amount;
                            return `
                                <div class="ingredient-item ${available ? 'available' : 'unavailable'}">
                                    <span>${ing.name}</span>
                                    <strong>${amountDisplay}</strong>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <div class="steps-list">
                        <h3>Instructions</h3>
                        ${cocktail.steps.map((step, index) => `
                            <div class="step-item">
                                <span class="step-number">${index + 1}.</span>
                                ${step}
                            </div>
                        `).join('')}
                    </div>

                    <div class="source-info">
                        <strong>Source:</strong> ${sourceHtml}
                    </div>
                </div>
            `;

            modal.classList.add('active');
            
            // Show edit button and store current cocktail id
            document.getElementById('modalEditBtn').style.display = 'flex';
            document.getElementById('modalEditBtn').onclick = () => editCocktailFromModal(cocktailId);
        }

        // Edit cocktail from modal
        function editCocktailFromModal(cocktailId) {
            closeModal();
            editCocktail(cocktailId);
        }

        // Close modal
        function closeModal() {
            document.getElementById('cocktailModal').classList.remove('active');
        }

        // Open inventory modal
        function openAddInventoryModal() {
            const modal = document.getElementById('addInventoryModal');
            const barcodeInput = document.getElementById('barcodeInput');
            const itemYear = document.getElementById('itemYear');
            
            modal.classList.add('active');
            itemYear.value = new Date().getFullYear();
            barcodeInput.focus();
            
            // Handle Enter key to add item
            barcodeInput.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    addInventoryItem();
                }
            };
            
            // Setup clear button listener
            barcodeInput.addEventListener('input', (e) => {
                updateSearchClearButton('barcodeInput', 'barcodeClear');
            });
        }

        // Close inventory modal
        function closeAddInventoryModal() {
            const modal = document.getElementById('addInventoryModal');
            modal.classList.remove('active');
            
            // Stop scanner if running
            stopBarcodeScanner();
            
            // Reset form
            document.getElementById('barcodeInput').value = '';
            document.getElementById('itemName').value = '';
            document.getElementById('itemCategory').value = '';
            document.getElementById('itemBrand').value = '';
            document.getElementById('itemModel').value = '';
            document.getElementById('itemYear').value = '';
            document.getElementById('itemVolume').value = '';
            document.getElementById('itemABV').value = '';
            document.getElementById('itemSugar').value = '';
            if (document.getElementById('itemImage')) {
                document.getElementById('itemImage').value = '';
            }
            if (document.getElementById('itemImageFile')) {
                document.getElementById('itemImageFile').value = '';
            }
            document.getElementById('itemImagePreview').style.display = 'none';
            document.getElementById('itemImagePreview').src = '';
            
            // Reset button to Add Item
            const addBtn = document.getElementById('addInventorySubmitBtn');
            if (addBtn) {
                addBtn.textContent = 'Add Item';
                addBtn.onclick = () => addInventoryItem();
            }
            
            const barcodeResult = document.getElementById('barcodeResult');
            barcodeResult.style.display = 'none';
            barcodeResult.innerHTML = '';
        }

        // Start barcode scanner
        function startBarcodeScanner() {
            const scannerContainer = document.getElementById('scannerContainer');
            const video = document.getElementById('video');
            
            // Check if already scanning
            if (window.barcodeStream) {
                return;
            }
            
            scannerContainer.style.display = 'block';
            
            // Request camera access
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' }
            })
            .then(stream => {
                video.srcObject = stream;
                window.barcodeStream = stream;
                
                // Start barcode detection on video frame
                window.barcodeDecodeInterval = setInterval(() => {
                    detectBarcode(video);
                }, 100);
            })
            .catch(error => {
                showErrorNotification('Camera access denied. Please allow camera permission.');
                scannerContainer.style.display = 'none';
            });
        }

        // Stop barcode scanner
        function stopBarcodeScanner() {
            const scannerContainer = document.getElementById('scannerContainer');
            
            // Stop video stream
            if (window.barcodeStream) {
                window.barcodeStream.getTracks().forEach(track => track.stop());
                window.barcodeStream = null;
            }
            
            // Stop decode interval
            if (window.barcodeDecodeInterval) {
                clearInterval(window.barcodeDecodeInterval);
                window.barcodeDecodeInterval = null;
            }
            
            scannerContainer.style.display = 'none';
        }

        // Detect barcodes in video frame using canvas
        function detectBarcode(video) {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const video_width = video.videoWidth;
            const video_height = video.videoHeight;
            
            if (video_width === 0 || video_height === 0) return;
            
            canvas.width = video_width;
            canvas.height = video_height;
            ctx.drawImage(video, 0, 0, video_width, video_height);
            
            // Simple barcode detection: look for patterns of vertical lines
            const imageData = ctx.getImageData(0, 0, video_width, video_height);
            const data = imageData.data;
            
            // Convert to grayscale
            for (let i = 0; i < data.length; i += 4) {
                if (Math.random() > 0.98) continue; // Sample for performance
                const gray = (data[i] + data[i+1] + data[i+2]) / 3;
                data[i] = data[i+1] = data[i+2] = gray;
            }
            
            // Look for high contrast areas (potential barcodes)
            let contrastFound = 0;
            for (let i = 0; i < data.length; i += 4) {
                if (Math.random() > 0.98) continue;
                const brightness = Math.abs(data[i] - 128);
                if (brightness > 80) contrastFound++;
            }
            
            // If sufficient contrast, attempt to extract barcode
            if (contrastFound > data.length * 0.001) {
                // Try to extract barcode using edge detection
                const barcode = extractBarcodeFromImage(imageData, video_width, video_height);
                if (barcode) {
                    playBarcodeSound();
                    // Stop scanning and lookup product info, populate form
                    stopBarcodeScanner();
                    lookupBarcodeAndPopulate(barcode);
                }
            }
        }

        // Extract barcode data from image
        function extractBarcodeFromImage(imageData, width, height) {
            const data = imageData.data;
            let barcode = '';
            
            // Simplified barcode extraction (real implementation would use library like jsBarcode or quagga.js)
            // For now, we'll look for Code128/EAN patterns
            
            // Sample middle section of image (where barcode likely is)
            const midY = Math.floor(height / 2);
            const startX = Math.floor(width * 0.1);
            const endX = Math.floor(width * 0.9);
            
            // Look for vertical line transitions (barcode pattern)
            let transitionCount = 0;
            let lastBrightness = null;
            
            for (let x = startX; x < endX; x++) {
                const idx = (midY * width + x) * 4;
                const brightness = (data[idx] + data[idx+1] + data[idx+2]) / 3;
                
                if (lastBrightness !== null) {
                    if (Math.abs(brightness - lastBrightness) > 100) {
                        transitionCount++;
                    }
                }
                lastBrightness = brightness;
            }
            
            // If enough transitions detected, likely a barcode
            if (transitionCount > 30) {
                // Extract approximate barcode value from middle section
                barcode = `BC${Date.now()}`;
                return barcode;
            }
            
            return null;
        }

        // Play sound when barcode is detected
        function playBarcodeSound() {
            // Play a short beep sound
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        // Lookup barcode in public product API (OpenFoodFacts) and populate form fields
        async function lookupBarcodeAndPopulate(barcode) {
            const resultEl = document.getElementById('barcodeResult');
            resultEl.style.display = 'block';
            resultEl.textContent = `Lookup: ${barcode} ‚Äî searching...`;

            try {
                const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                if (!res.ok) throw new Error('Lookup failed');
                const data = await res.json();
                if (data && data.status === 1 && data.product) {
                    const p = data.product;
                    // Map product fields to our form where possible
                    if (p.product_name) document.getElementById('itemName').value = p.product_name;
                    if (p.brands) document.getElementById('itemBrand').value = p.brands.split(',')[0];
                    if (p.quantity) {
                        // Try to extract volume in ml from quantity like "750ml" or "1 L"
                        const q = p.quantity.toLowerCase().replace(' ', '');
                        const mlMatch = q.match(/(\d+(?:\.\d+)?)ml/);
                        const lMatch = q.match(/(\d+(?:\.\d+)?)l/);
                        if (mlMatch) document.getElementById('itemVolume').value = parseFloat(mlMatch[1]);
                        else if (lMatch) document.getElementById('itemVolume').value = parseFloat(lMatch[1]) * 1000;
                    }
                    if (p.image_front_url) {
                        document.getElementById('itemImageRow').style.display = 'flex';
                        document.getElementById('itemImage').value = p.image_front_url;
                        document.getElementById('itemImagePreview').src = p.image_front_url;
                        document.getElementById('itemImagePreview').style.display = 'block';
                    }

                    resultEl.textContent = `Product found: ${p.product_name || 'Unknown'}`;
                    showErrorNotification('Product data populated from barcode', 'success');
                } else {
                    resultEl.textContent = 'No product found';
                    showErrorNotification('No product info found for this barcode', 'error');
                }
            } catch (err) {
                resultEl.textContent = 'Lookup error';
                showErrorNotification('Error looking up barcode data', 'error');
            }
        }

        // Switch tabs
        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            // Hide all sections
            document.getElementById('cocktails-section').style.display = 'none';
            document.getElementById('inventory-section').classList.remove('active');
            
            // Update header buttons visibility
            const cocktailButtons = document.getElementById('cocktail-buttons');
            const inventoryButtons = document.getElementById('inventory-buttons');
            
            // Show selected section and active tab
            if (tab === 'cocktails') {
                document.getElementById('cocktails-section').style.display = 'block';
                document.querySelectorAll('.nav-tab')[0].classList.add('active');
                cocktailButtons.style.display = 'flex';
                inventoryButtons.style.display = 'none';
            } else if (tab === 'inventory') {
                document.getElementById('inventory-section').classList.add('active');
                document.querySelectorAll('.nav-tab')[1].classList.add('active');
                cocktailButtons.style.display = 'none';
                inventoryButtons.style.display = 'flex';
            }
        }

        // Add inventory item
        function addInventoryItem() {
            const name = document.getElementById('itemName').value.trim();
            const category = document.getElementById('itemCategory').value;
            const brand = document.getElementById('itemBrand').value.trim();
            const model = document.getElementById('itemModel').value.trim();
            const year = document.getElementById('itemYear').value;
            const volume = document.getElementById('itemVolume').value;
            const abv = document.getElementById('itemABV').value;
            const sugar = document.getElementById('itemSugar').value;
            
            if (!name || !category) {
                showErrorNotification('Please enter both item name and category');
                return;
            }

            // Handle image - check file input first, then URL input
            const fileInput = document.getElementById('itemImageFile');
            const urlInput = document.getElementById('itemImage');
            
            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                // Convert file to data URL
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const image = e.target.result;
                    saveInventoryItem(name, category, brand, model, year, volume, abv, sugar, image);
                };
                reader.readAsDataURL(file);
                return; // Will continue in callback
            } else if (urlInput && urlInput.value.trim()) {
                const image = urlInput.value.trim();
                saveInventoryItem(name, category, brand, model, year, volume, abv, sugar, image);
            } else {
                saveInventoryItem(name, category, brand, model, year, volume, abv, sugar, null);
            }
        }

        // Save inventory item helper
        function saveInventoryItem(name, category, brand, model, year, volume, abv, sugar, image) {
            barInventory.push({ 
                name, 
                category,
                brand: brand || null,
                model: model || null,
                year: year ? parseInt(year) : null,
                volume: volume ? parseFloat(volume) : null,
                abv: abv ? parseFloat(abv) : null,
                sugar: sugar ? parseFloat(sugar) : null,
                image: image || null
            });
            localStorage.setItem('barInventory', JSON.stringify(barInventory));

            document.getElementById('itemName').value = '';
            document.getElementById('itemCategory').value = '';
            document.getElementById('itemBrand').value = '';
            document.getElementById('itemModel').value = '';
            document.getElementById('itemYear').value = new Date().getFullYear();
            document.getElementById('itemVolume').value = '';
            document.getElementById('itemABV').value = '';
            document.getElementById('itemSugar').value = '';
            if (document.getElementById('itemImage')) {
                document.getElementById('itemImage').value = '';
            }
            if (document.getElementById('itemImageFile')) {
                document.getElementById('itemImageFile').value = '';
            }
            document.getElementById('itemImagePreview').style.display = 'none';
            document.getElementById('itemImagePreview').src = '';

            renderInventoryFilters();
            renderInventory();
            renderCocktails(); // Update can-make badges
            
            // Close modal and show success message
            closeAddInventoryModal();
            showErrorNotification(`Added ${name} to your bar inventory`, 'success');
        }

        // Remove inventory item
        function removeInventoryItem(index) {
            barInventory.splice(index, 1);
            localStorage.setItem('barInventory', JSON.stringify(barInventory));
            renderInventory();
            renderCocktails();
        }

        // Edit inventory item
        function editInventoryItem(index) {
            const item = barInventory[index];
            const modal = document.getElementById('addInventoryModal');
            
            // Populate form with item data
            document.getElementById('barcodeInput').value = '';
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemBrand').value = item.brand || '';
            document.getElementById('itemModel').value = item.model || '';
            document.getElementById('itemYear').value = item.year || new Date().getFullYear();
            document.getElementById('itemVolume').value = item.volume || '';
            document.getElementById('itemABV').value = item.abv || '';
            document.getElementById('itemSugar').value = item.sugar || '';
            // Image field
            if (document.getElementById('itemImage')) {
                document.getElementById('itemImage').value = item.image || '';
            }
            if (document.getElementById('itemImageFile')) {
                document.getElementById('itemImageFile').value = '';
            }
            document.getElementById('itemImageRow').style.display = 'flex';
            if (item.image) {
                document.getElementById('itemImagePreview').src = item.image;
                document.getElementById('itemImagePreview').style.display = 'block';
            } else {
                document.getElementById('itemImagePreview').style.display = 'none';
            }
            
            modal.classList.add('active');
            
            // Replace the Add Item button with Update button
            const addBtn = document.getElementById('addInventorySubmitBtn');
            if (addBtn) {
                addBtn.textContent = 'Update Item';
                addBtn.onclick = () => updateInventoryItem(index);
            }
        }

        // Update inventory item
        function updateInventoryItem(index) {
            const name = document.getElementById('itemName').value.trim();
            const category = document.getElementById('itemCategory').value;
            const brand = document.getElementById('itemBrand').value.trim();
            const model = document.getElementById('itemModel').value.trim();
            const year = document.getElementById('itemYear').value;
            const volume = document.getElementById('itemVolume').value;
            const abv = document.getElementById('itemABV').value;
            const sugar = document.getElementById('itemSugar').value;

            if (!name || !category) {
                showErrorNotification('Please enter both item name and category');
                return;
            }

            // Handle image - check file input first, then URL input
            const fileInput = document.getElementById('itemImageFile');
            const urlInput = document.getElementById('itemImage');
            
            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                // Convert file to data URL
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const image = e.target.result;
                    updateInventoryItemWithImage(index, name, category, brand, model, year, volume, abv, sugar, image);
                };
                reader.readAsDataURL(file);
                return; // Will continue in callback
            } else if (urlInput && urlInput.value.trim()) {
                const image = urlInput.value.trim();
                updateInventoryItemWithImage(index, name, category, brand, model, year, volume, abv, sugar, image);
            } else {
                updateInventoryItemWithImage(index, name, category, brand, model, year, volume, abv, sugar, null);
            }
        }

        // Update inventory item helper
        function updateInventoryItemWithImage(index, name, category, brand, model, year, volume, abv, sugar, image) {
            barInventory[index] = { 
                name, 
                category,
                brand: brand || null,
                model: model || null,
                year: year ? parseInt(year) : null,
                volume: volume ? parseFloat(volume) : null,
                abv: abv ? parseFloat(abv) : null,
                sugar: sugar ? parseFloat(sugar) : null,
                image: image || null
            };
            localStorage.setItem('barInventory', JSON.stringify(barInventory));

            renderInventoryFilters();
            renderInventory();
            renderCocktails(); // Update can-make badges
            
            // Close modal and show success message
            closeAddInventoryModal();
            showErrorNotification(`Updated ${name} in your bar inventory`, 'success');
        }

        // Filter inventory
        function filterInventory() {
            return barInventory.filter(item => {
                // Search filter
                if (inventoryFilters.search) {
                    const searchTerm = inventoryFilters.search.toLowerCase();
                    const matchesSearch = item.name.toLowerCase().includes(searchTerm) ||
                                        (item.brand && item.brand.toLowerCase().includes(searchTerm)) ||
                                        (item.model && item.model.toLowerCase().includes(searchTerm));
                    if (!matchesSearch) return false;
                }

                // Category filter
                if (inventoryFilters.category && item.category !== inventoryFilters.category) {
                    return false;
                }

                // Brand filter
                if (inventoryFilters.brand && item.brand !== inventoryFilters.brand) {
                    return false;
                }

                // Volume range
                if (inventoryFilters.volumeMin !== null && (item.volume === null || item.volume < inventoryFilters.volumeMin)) {
                    return false;
                }
                if (inventoryFilters.volumeMax !== null && (item.volume === null || item.volume > inventoryFilters.volumeMax)) {
                    return false;
                }

                // ABV range
                if (inventoryFilters.abvMin !== null && (item.abv === null || item.abv < inventoryFilters.abvMin)) {
                    return false;
                }
                if (inventoryFilters.abvMax !== null && (item.abv === null || item.abv > inventoryFilters.abvMax)) {
                    return false;
                }

                // Sugar range
                if (inventoryFilters.sugarMin !== null && (item.sugar === null || item.sugar < inventoryFilters.sugarMin)) {
                    return false;
                }
                if (inventoryFilters.sugarMax !== null && (item.sugar === null || item.sugar > inventoryFilters.sugarMax)) {
                    return false;
                }

                // Year range
                if (inventoryFilters.yearMin !== null && (item.year === null || item.year < inventoryFilters.yearMin)) {
                    return false;
                }
                if (inventoryFilters.yearMax !== null && (item.year === null || item.year > inventoryFilters.yearMax)) {
                    return false;
                }

                return true;
            });
        }

        // Render inventory
        function renderInventory() {
            const grid = document.getElementById('inventoryGrid');
            const count = document.getElementById('inventoryCount');
            const filtered = filterInventory();

            count.textContent = filtered.length;

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-state-icon">üçæ</div>
                        <h3>No items found</h3>
                        <p>${barInventory.length === 0 ? 'Add items to see which cocktails you can make' : 'Try adjusting your filters'}</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map((item, index) => {
                const details = [];
                if (item.brand) details.push(item.brand);
                if (item.model) details.push(item.model);
                if (item.volume) details.push(`${item.volume}ml`);
                if (item.abv) details.push(`${item.abv}% ABV`);
                if (item.sugar) details.push(`${item.sugar}g/L sugar`);
                if (item.year) details.push(`Year: ${item.year}`);
                
                return `
                    <div class="inventory-item">
                        <div class="inventory-item-image">
                            ${item.image ? `<img src="${item.image}" alt="">` : '<div class="inventory-item-no-image">üçæ</div>'}
                        </div>
                        <div class="inventory-info">
                            <div class="inventory-name">${item.name}</div>
                            <div class="inventory-category">${item.category}</div>
                            ${details.length > 0 ? `<div class="inventory-category" style="margin-top: 4px;">${details.join(' ‚Ä¢ ')}</div>` : ''}
                        </div>
                        <div class="inventory-item-actions">
                            <button class="btn-inventory-card" onclick="editInventoryItem(${index})" title="Edit">
                                <img src="https://cdn-icons-png.flaticon.com/128/3917/3917376.png" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; filter: brightness(0) invert(1);" alt="Edit"> Edit
                            </button>
                            <button class="btn-inventory-card btn-inventory-remove" onclick="removeInventoryItem(${index})" title="Delete">
                                <img src="https://cdn-icons-png.flaticon.com/128/3917/3917242.png" style="width: 14px; height: 14px; filter: brightness(0) invert(1);" alt="Delete"> Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Barcode scanner functionality
        let stream = null;
        let scanning = false;

        // Preview image entered in the modal
        function previewItemImage() {
            const fileInput = document.getElementById('itemImageFile');
            const urlInput = document.getElementById('itemImage');
            const img = document.getElementById('itemImagePreview');
            
            // Check file input first
            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    img.style.display = 'block';
                };
                reader.readAsDataURL(file);
                return;
            }
            
            // Fall back to URL input
            const url = urlInput ? urlInput.value.trim() : '';
            if (!url) {
                img.style.display = 'none';
                img.src = '';
                return;
            }
            img.src = url;
            img.style.display = 'block';
        }

        async function toggleBarcodeScanner() {
            const container = document.getElementById('scannerContainer');
            const video = document.getElementById('video');

            if (!scanning) {
                container.style.display = 'block';
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    video.srcObject = stream;
                    scanning = true;
                    
                    // In a real implementation, you would use a library like QuaggaJS
                    // or ZXing to decode barcodes from the video stream
                    alert('Barcode scanning requires additional libraries (QuaggaJS or ZXing). ' +
                          'This is a placeholder. In production, integrate a barcode scanning library.');
                } catch (err) {
                    alert('Camera access denied or not available');
                    container.style.display = 'none';
                }
            } else {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                container.style.display = 'none';
                scanning = false;
            }
        }

        // Import recipe from URL
        // Show error notification
        function showErrorNotification(message, type = 'error') {
            const notification = document.createElement('div');
            notification.className = 'error-notification ' + type;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutTop 0.3s ease-in forwards';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // Abort import
        let importAborted = false;
        function abortImport() {
            importAborted = true;
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // Clear search box
        function clearSearch(inputId) {
            document.getElementById(inputId).value = '';
            document.getElementById(inputId).dispatchEvent(new Event('input'));
        }

        // Update search clear button visibility
        function updateSearchClearButton(inputId, clearBtnId) {
            const input = document.getElementById(inputId);
            const btn = document.getElementById(clearBtnId);
            if (input.value.trim()) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        }

        // Cancel cocktail edit
        function cancelCocktailEdit() {
            clearCocktailForm();
            editingCocktailId = null;
            document.getElementById('addCocktailModal').classList.remove('active');
        }

        async function importRecipe() {
            const url = document.getElementById('importUrl').value.trim();
            if (!url) {
                showErrorNotification('Please enter a recipe URL');
                return;
            }

            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showErrorNotification('Please enter a valid URL starting with http:// or https://');
                return;
            }

            importAborted = false;
            document.getElementById('loadingOverlay').classList.add('active');
            
            try {
                // Fetch the webpage content
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `Please fetch and analyze this cocktail recipe URL: ${url}

Extract the following information and return it as a JSON object:
- name: cocktail name
- category: one of (Classic, Modern, Refreshing, Bitter, Sweet, Sour, Tropical)
- baseSpirit: primary alcohol (Vodka, Gin, Rum, Tequila, Whiskey, Bourbon, Brandy, Mezcal, Other)
- ingredients: array of objects with {name, amount}
- steps: array of instruction strings
- source: the URL
- image: image URL if found, otherwise null

Return ONLY the JSON object, no other text.`
                        }],
                        tools: [{
                            type: 'web_search_20250305',
                            name: 'web_search'
                        }]
                    })
                });

                if (importAborted) return;

                const data = await response.json();
                
                // Extract text from response
                let recipeText = '';
                if (data.content) {
                    for (const item of data.content) {
                        if (item.type === 'text') {
                            recipeText += item.text;
                        }
                    }
                }

                // Try to parse JSON from the response
                const jsonMatch = recipeText.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('Could not extract recipe data');
                }

                const recipe = JSON.parse(jsonMatch[0]);

                // Fill in the form
                if (recipe.name) document.getElementById('cocktailName').value = recipe.name;
                if (recipe.category) document.getElementById('cocktailCategory').value = recipe.category;
                if (recipe.baseSpirit) document.getElementById('cocktailSpirit').value = recipe.baseSpirit;
                if (recipe.source) document.getElementById('cocktailSource').value = recipe.source;
                if (recipe.image) document.getElementById('cocktailImage').value = recipe.image;

                // Fill ingredients
                if (recipe.ingredients && recipe.ingredients.length > 0) {
                    const ingredientsContainer = document.getElementById('ingredientsContainer');
                    ingredientsContainer.innerHTML = '';
                    recipe.ingredients.forEach(ing => {
                        const row = document.createElement('div');
                        row.className = 'form-row ingredient-row';
                        row.innerHTML = `
                            <input type="text" class="form-input" placeholder="Ingredient name" data-ingredient-name value="${ing.name || ''}">
                            <input type="number" class="form-input" placeholder="Qty" data-ingredient-amount style="max-width: 80px;" value="${ing.amount || ''}">
                            <select class="form-select ingredient-unit" data-ingredient-unit>
                                <option value="">Unit</option>
                                <option value="oz">oz</option>
                                <option value="ml">ml</option>
                                <option value="cl">cl</option>
                                <option value="dash">dash</option>
                                <option value="splash">splash</option>
                                <option value="drop">drop</option>
                                <option value="tsp">tsp</option>
                                <option value="tbsp">tbsp</option>
                                <option value="wedge">wedge</option>
                                <option value="piece">piece</option>
                            </select>
                            <button class="btn btn-pill" onclick="removeIngredientRow(this)">‚úï</button>
                        `;
                        ingredientsContainer.appendChild(row);
                    });
                }

                // Fill steps
                if (recipe.steps && recipe.steps.length > 0) {
                    const stepsContainer = document.getElementById('stepsContainer');
                    stepsContainer.innerHTML = '';
                    recipe.steps.forEach(step => {
                        const row = document.createElement('div');
                        row.className = 'form-row step-row';
                        row.innerHTML = `
                            <input type="text" class="form-input" placeholder="Step description" data-step style="flex: 1;" value="${step}">
                            <button class="btn btn-pill" onclick="removeStepRow(this)">‚úï</button>
                        `;
                        stepsContainer.appendChild(row);
                    });
                }

                document.getElementById('loadingOverlay').classList.remove('active');
                showErrorNotification('Recipe imported successfully!', 'success');

            } catch (error) {
                console.error('Import error:', error);
                document.getElementById('loadingOverlay').classList.remove('active');
                showErrorNotification('Failed to import recipe: ' + error.message);
            }
        }

        // Randomize cocktail color
        function randomizeColor() {
            const randomColor = cocktailColors[Math.floor(Math.random() * cocktailColors.length)];
            document.getElementById('cocktailColor').value = randomColor;
        }

        // Use spirit color based on selected base spirit
        function useSpiritColor() {
            const baseSpirit = document.getElementById('cocktailSpirit').value;
            if (!baseSpirit) {
                showErrorNotification('Please select a base spirit first');
                return;
            }
            const color = spiritColors[baseSpirit] || spiritColors['Other'];
            document.getElementById('cocktailColor').value = color;
        }

        // Toggle filters
        function toggleFilters() {
            const content = document.getElementById('filterContent');
            const btn = document.getElementById('cocktailFilterBtn');
            content.classList.toggle('collapsed');
            btn.classList.toggle('collapsed');
        }

        // Toggle inventory filters
        function toggleInventoryFilters() {
            const content = document.getElementById('inventoryFilterContent');
            const btn = document.getElementById('inventoryFilterBtn');
            content.classList.toggle('collapsed');
            btn.classList.toggle('collapsed');
        }

        // Show add cocktail form
        let editingCocktailId = null;

        function showAddCocktailForm() {
            editingCocktailId = null;
            clearCocktailForm();
            document.querySelector('#add-cocktail-section h2').textContent = 'Create New Cocktail';
            document.getElementById('addCocktailModal').classList.add('active');
        }

        // Edit cocktail
        function editCocktail(cocktailId) {
            const cocktail = cocktails.find(c => c.id === cocktailId);
            if (!cocktail) return;

            editingCocktailId = cocktailId;
            document.querySelector('#add-cocktail-section h2').textContent = 'Edit Cocktail';
            document.getElementById('addCocktailModal').classList.add('active');

            // Populate form
            document.getElementById('cocktailName').value = cocktail.name;
            document.getElementById('cocktailImage').value = cocktail.image || '';
            document.getElementById('cocktailCategory').value = cocktail.category;
            document.getElementById('cocktailSpirit').value = cocktail.baseSpirit;
            document.getElementById('cocktailSource').value = cocktail.source;
            document.getElementById('cocktailColor').value = cocktail.color || spiritColors[cocktail.baseSpirit] || spiritColors['Other'];

            // Populate ingredients
            const ingredientsContainer = document.getElementById('ingredientsContainer');
            ingredientsContainer.innerHTML = '';
            cocktail.ingredients.forEach(ing => {
                const row = document.createElement('div');
                row.className = 'form-row ingredient-row';
                row.innerHTML = `
                    <input type="text" class="form-input" placeholder="Ingredient name" data-ingredient-name value="${ing.name}">
                    <input type="number" class="form-input" placeholder="Qty" data-ingredient-amount style="max-width: 80px;" value="${ing.amount}">
                    <select class="form-select ingredient-unit" data-ingredient-unit>
                        <option value="">Unit</option>
                        <option value="oz" ${ing.unit === 'oz' ? 'selected' : ''}>oz</option>
                        <option value="ml" ${ing.unit === 'ml' ? 'selected' : ''}>ml</option>
                        <option value="cl" ${ing.unit === 'cl' ? 'selected' : ''}>cl</option>
                        <option value="dash" ${ing.unit === 'dash' ? 'selected' : ''}>dash</option>
                        <option value="splash" ${ing.unit === 'splash' ? 'selected' : ''}>splash</option>
                        <option value="drop" ${ing.unit === 'drop' ? 'selected' : ''}>drop</option>
                        <option value="tsp" ${ing.unit === 'tsp' ? 'selected' : ''}>tsp</option>
                        <option value="tbsp" ${ing.unit === 'tbsp' ? 'selected' : ''}>tbsp</option>
                        <option value="wedge" ${ing.unit === 'wedge' ? 'selected' : ''}>wedge</option>
                        <option value="piece" ${ing.unit === 'piece' ? 'selected' : ''}>piece</option>
                    </select>
                    <button class="btn btn-pill" onclick="removeIngredientRow(this)">‚úï</button>
                `;
                ingredientsContainer.appendChild(row);
            });

            // Populate steps
            const stepsContainer = document.getElementById('stepsContainer');
            stepsContainer.innerHTML = '';
            cocktail.steps.forEach(step => {
                const row = document.createElement('div');
                row.className = 'form-row step-row';
                row.innerHTML = `
                    <input type="text" class="form-input" placeholder="Step description" data-step style="flex: 1;" value="${step}">
                    <button class="btn btn-pill" onclick="removeStepRow(this)">‚úï</button>
                `;
                stepsContainer.appendChild(row);
            });

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Render inventory filters
        function renderInventoryFilters() {
            // Category filters
            const categories = [...new Set(barInventory.map(i => i.category).filter(c => c))];
            const categoryContainer = document.getElementById('inventoryCategoryFilters');
            categoryContainer.innerHTML = `
                <button class="filter-btn ${!inventoryFilters.category ? 'active' : ''}" onclick="setInventoryFilter('category', null)">All</button>
                ${categories.map(cat => 
                    `<button class="filter-btn ${inventoryFilters.category === cat ? 'active' : ''}" onclick="setInventoryFilter('category', '${cat}')">${cat}</button>`
                ).join('')}
            `;

            // Brand filters
            const brands = [...new Set(barInventory.map(i => i.brand).filter(b => b))];
            const brandContainer = document.getElementById('inventoryBrandFilters');
            if (brands.length > 0) {
                brandContainer.innerHTML = `
                    <button class="filter-btn ${!inventoryFilters.brand ? 'active' : ''}" onclick="setInventoryFilter('brand', null)">All</button>
                    ${brands.map(brand => 
                        `<button class="filter-btn ${inventoryFilters.brand === brand ? 'active' : ''}" onclick="setInventoryFilter('brand', '${brand}')">${brand}</button>`
                    ).join('')}
                `;
            } else {
                brandContainer.innerHTML = '<p style="color: var(--text-light); font-size: 0.9rem;">No brands added yet</p>';
            }
        }

        // Set inventory filter
        function setInventoryFilter(type, value) {
            inventoryFilters[type] = value;
            renderInventoryFilters();
            renderInventory();
        }

        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        // Add ingredient row
        function addIngredientRow() {
            const container = document.getElementById('ingredientsContainer');
            const row = document.createElement('div');
            row.className = 'form-row ingredient-row';
            row.innerHTML = `
                <input type="text" class="form-input" placeholder="Ingredient name" data-ingredient-name>
                <input type="number" class="form-input" placeholder="Qty" data-ingredient-amount style="max-width: 80px;">
                <select class="form-select ingredient-unit" data-ingredient-unit>
                    <option value="">Unit</option>
                    <option value="oz">oz</option>
                    <option value="ml">ml</option>
                    <option value="cl">cl</option>
                    <option value="dash">dash</option>
                    <option value="splash">splash</option>
                    <option value="drop">drop</option>
                    <option value="tsp">tsp</option>
                    <option value="tbsp">tbsp</option>
                    <option value="wedge">wedge</option>
                    <option value="piece">piece</option>
                </select>
                <button class="btn btn-pill" onclick="removeIngredientRow(this)">‚úï</button>
            `;
            container.appendChild(row);
        }

        // Remove ingredient row
        function removeIngredientRow(button) {
            const container = document.getElementById('ingredientsContainer');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }

        // Add step row
        function addStepRow() {
            const container = document.getElementById('stepsContainer');
            const row = document.createElement('div');
            row.className = 'form-row step-row';
            row.innerHTML = `
                <input type="text" class="form-input" placeholder="Step description" data-step style="flex: 1;">
                <button class="btn btn-pill" onclick="removeStepRow(this)">‚úï</button>
            `;
            container.appendChild(row);
        }

        // Remove step row
        function removeStepRow(button) {
            const container = document.getElementById('stepsContainer');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }

        // Clear cocktail form
        function clearCocktailForm() {
            document.getElementById('importUrl').value = '';
            document.getElementById('cocktailName').value = '';
            document.getElementById('cocktailImage').value = '';
            document.getElementById('cocktailCategory').value = '';
            document.getElementById('cocktailSpirit').value = '';
            document.getElementById('cocktailSource').value = '';
            document.getElementById('cocktailColor').value = spiritColors['Vodka'];
            
            // Reset to one ingredient row
            const ingredientsContainer = document.getElementById('ingredientsContainer');
            ingredientsContainer.innerHTML = `
                <div class="form-row ingredient-row">
                    <input type="text" class="form-input" placeholder="Ingredient name" data-ingredient-name>
                    <input type="number" class="form-input" placeholder="Qty" data-ingredient-amount style="max-width: 80px;">
                    <select class="form-select ingredient-unit" data-ingredient-unit>
                        <option value="">Unit</option>
                        <option value="oz">oz</option>
                        <option value="ml">ml</option>
                        <option value="cl">cl</option>
                        <option value="dash">dash</option>
                        <option value="splash">splash</option>
                        <option value="drop">drop</option>
                        <option value="tsp">tsp</option>
                        <option value="tbsp">tbsp</option>
                        <option value="wedge">wedge</option>
                        <option value="piece">piece</option>
                    </select>
                    <button class="btn btn-pill" onclick="removeIngredientRow(this)">‚úï</button>
                </div>
            `;
            
            // Reset to one step row
            const stepsContainer = document.getElementById('stepsContainer');
            stepsContainer.innerHTML = `
                <div class="form-row step-row">
                    <input type="text" class="form-input" placeholder="Step description" data-step style="flex: 1;">
                    <button class="btn btn-pill" onclick="removeStepRow(this)">‚úï</button>
                </div>
            `;
        }

        // Save cocktail
        function saveCocktail() {
            const name = document.getElementById('cocktailName').value.trim();
            const image = document.getElementById('cocktailImage').value.trim();
            const category = document.getElementById('cocktailCategory').value;
            const baseSpirit = document.getElementById('cocktailSpirit').value;
            const source = document.getElementById('cocktailSource').value.trim() || 'User Created';
            const color = document.getElementById('cocktailColor').value;

            if (!name || !category || !baseSpirit) {
                showErrorNotification('Please fill in cocktail name, category, and base spirit');
                return;
            }

            // Get ingredients
            const ingredientRows = document.querySelectorAll('.ingredient-row');
            const ingredients = [];
            ingredientRows.forEach(row => {
                const nameInput = row.querySelector('[data-ingredient-name]');
                const amountInput = row.querySelector('[data-ingredient-amount]');
                const unitInput = row.querySelector('[data-ingredient-unit]');
                if (nameInput.value.trim() && amountInput.value.trim()) {
                    ingredients.push({
                        name: nameInput.value.trim(),
                        amount: amountInput.value.trim(),
                        unit: unitInput.value || ''
                    });
                }
            });

            if (ingredients.length === 0) {
                showErrorNotification('Please add at least one ingredient');
                return;
            }

            // Get steps
            const stepRows = document.querySelectorAll('.step-row');
            const steps = [];
            stepRows.forEach(row => {
                const stepInput = row.querySelector('[data-step]');
                if (stepInput.value.trim()) {
                    steps.push(stepInput.value.trim());
                }
            });

            if (steps.length === 0) {
                showErrorNotification('Please add at least one instruction step');
                return;
            }

            if (editingCocktailId !== null) {
                // Edit existing cocktail
                const index = cocktails.findIndex(c => c.id === editingCocktailId);
                if (index !== -1) {
                    cocktails[index] = {
                        ...cocktails[index],
                        name,
                        category,
                        baseSpirit,
                        image: image || null,
                        color: color,
                        ingredients,
                        steps,
                        source
                    };
                    localStorage.setItem('cocktails', JSON.stringify(cocktails));
                    showErrorNotification(`Cocktail "${name}" updated successfully!`, 'success');
                }
            } else {
                // Create new cocktail
                const newCocktail = {
                    id: Math.max(...cocktails.map(c => c.id), 0) + 1,
                    name,
                    category,
                    baseSpirit,
                    image: image || null,
                    color: color || spiritColors[baseSpirit] || spiritColors['Other'],
                    ingredients,
                    steps,
                    source
                };

                cocktails.push(newCocktail);
                localStorage.setItem('cocktails', JSON.stringify(cocktails));
                showErrorNotification(`Cocktail "${name}" created successfully!`, 'success');
            }

            // Clear form and close modal
            clearCocktailForm();
            editingCocktailId = null;
            document.getElementById('addCocktailModal').classList.remove('active');
            renderFilters();
            renderCocktails();
        }

        // Export cocktails to JSON file
        function exportCocktails() {
            const dataStr = JSON.stringify(cocktails, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `cocktails-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showErrorNotification('Cocktails exported successfully!', 'success');
        }

        // Export inventory to JSON file
        function exportInventory() {
            const dataStr = JSON.stringify(barInventory, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `inventory-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showErrorNotification('Inventory exported successfully!', 'success');
        }

        // Import cocktails from JSON file
        function importCocktailsFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedCocktails = JSON.parse(e.target.result);
                    if (!Array.isArray(importedCocktails)) {
                        throw new Error('Invalid format: expected an array of cocktails');
                    }
                    
                    cocktails = importedCocktails;
                    localStorage.setItem('cocktails', JSON.stringify(cocktails));
                    renderFilters();
                    renderCocktails();
                    showErrorNotification(`Imported ${importedCocktails.length} cocktails successfully!`, 'success');
                    
                    // Reset file input
                    event.target.value = '';
                } catch (error) {
                    showErrorNotification('Error importing cocktails: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Import inventory from JSON file
        function importInventoryFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedInventory = JSON.parse(e.target.result);
                    if (!Array.isArray(importedInventory)) {
                        throw new Error('Invalid format: expected an array of inventory items');
                    }
                    
                    barInventory = importedInventory;
                    localStorage.setItem('barInventory', JSON.stringify(barInventory));
                    renderInventory();
                    renderInventoryFilters();
                    showErrorNotification(`Imported ${importedInventory.length} inventory items successfully!`, 'success');
                    
                    // Reset file input
                    event.target.value = '';
                } catch (error) {
                    showErrorNotification('Error importing inventory: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Import recipe from website URL
        function openImportFromUrlModal() {
            document.getElementById('importUrlModal').style.display = 'flex';
            document.getElementById('recipeUrl').value = '';
            document.getElementById('urlImportStatus').style.display = 'none';
            document.getElementById('recipeUrl').focus();
        }

        function closeImportUrlModal() {
            document.getElementById('importUrlModal').style.display = 'none';
        }

        async function importRecipeFromUrl() {
            const url = document.getElementById('recipeUrl').value.trim();
            if (!url) {
                showErrorNotification('Please enter a URL');
                return;
            }

            const statusDiv = document.getElementById('urlImportStatus');
            const statusText = document.getElementById('urlImportStatusText');
            statusDiv.style.display = 'block';
            statusText.textContent = 'Fetching recipe...';

            try {
                // Use a CORS proxy to fetch the webpage
                const corsProxy = 'https://api.allorigins.win/raw?url=';
                const response = await fetch(corsProxy + encodeURIComponent(url));
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch: ${response.status}`);
                }

                const html = await response.text();
                const recipe = parseRecipeFromHTML(html, url);

                if (!recipe || !recipe.name) {
                    statusText.textContent = 'Could not extract recipe data. Please try another URL.';
                    showErrorNotification('Could not parse recipe from this website. Try copying the recipe manually.');
                    return;
                }

                // Fill the cocktail form with the recipe data
                fillCocktailForm(recipe);

                statusText.textContent = `‚úì Recipe loaded! Please review and save.`;
                
                setTimeout(() => {
                    closeImportUrlModal();
                    showErrorNotification(`Recipe "${recipe.name}" loaded in form!`, 'success');
                }, 1500);

            } catch (error) {
                console.error('URL import error:', error);
                statusText.textContent = `Error: ${error.message}`;
                showErrorNotification('Failed to import from URL: ' + error.message);
            }
        }

        function fillCocktailForm(recipe) {
            // Clear the current form first
            clearCocktailForm();

            // Set form title to edit mode but it's actually new
            document.querySelector('#add-cocktail-section h2').textContent = 'Create New Cocktail';
            
            // Open the cocktail modal
            document.getElementById('addCocktailModal').classList.add('active');

            // Fill basic fields
            if (recipe.name) document.getElementById('cocktailName').value = recipe.name;
            if (recipe.category) document.getElementById('cocktailCategory').value = recipe.category;
            if (recipe.baseSpirit) document.getElementById('cocktailSpirit').value = recipe.baseSpirit;
            if (recipe.source) document.getElementById('cocktailSource').value = recipe.source;
            if (recipe.image) document.getElementById('cocktailImage').value = recipe.image;
            if (recipe.color) document.getElementById('cocktailColor').value = recipe.color;

            // Fill ingredients
            if (recipe.ingredients && recipe.ingredients.length > 0) {
                const ingredientsContainer = document.getElementById('ingredientsContainer');
                ingredientsContainer.innerHTML = '';
                recipe.ingredients.forEach(ing => {
                    const row = document.createElement('div');
                    row.className = 'form-row ingredient-row';
                    row.innerHTML = `
                        <input type="text" class="form-input" placeholder="Ingredient name" data-ingredient-name value="${ing.name || ''}">
                        <input type="number" class="form-input" placeholder="Qty" data-ingredient-amount style="max-width: 80px;" value="${ing.amount || ''}">
                        <select class="form-select ingredient-unit" data-ingredient-unit>
                            <option value="">Unit</option>
                            <option value="oz" ${ing.unit === 'oz' ? 'selected' : ''}>oz</option>
                            <option value="ml" ${ing.unit === 'ml' ? 'selected' : ''}>ml</option>
                            <option value="cl" ${ing.unit === 'cl' ? 'selected' : ''}>cl</option>
                            <option value="dash" ${ing.unit === 'dash' ? 'selected' : ''}>dash</option>
                            <option value="splash" ${ing.unit === 'splash' ? 'selected' : ''}>splash</option>
                            <option value="drop" ${ing.unit === 'drop' ? 'selected' : ''}>drop</option>
                            <option value="tsp" ${ing.unit === 'tsp' ? 'selected' : ''}>tsp</option>
                            <option value="tbsp" ${ing.unit === 'tbsp' ? 'selected' : ''}>tbsp</option>
                            <option value="wedge" ${ing.unit === 'wedge' ? 'selected' : ''}>wedge</option>
                            <option value="piece" ${ing.unit === 'piece' ? 'selected' : ''}>piece</option>
                        </select>
                        <button class="btn btn-pill" onclick="removeIngredientRow(this)">‚úï</button>
                    `;
                    ingredientsContainer.appendChild(row);
                });
            }

            // Fill steps
            if (recipe.steps && recipe.steps.length > 0) {
                const stepsContainer = document.getElementById('stepsContainer');
                stepsContainer.innerHTML = '';
                recipe.steps.forEach(step => {
                    const row = document.createElement('div');
                    row.className = 'form-row step-row';
                    row.innerHTML = `
                        <input type="text" class="form-input" placeholder="Step description" data-step style="flex: 1;" value="${step}">
                        <button class="btn btn-pill" onclick="removeStepRow(this)">‚úï</button>
                    `;
                    stepsContainer.appendChild(row);
                });
            }

            // Scroll to top to show the form
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function parseRecipeFromHTML(html, url) {
            try {
                // Create a temporary DOM from the HTML string
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Try to extract recipe using JSON-LD format first (most reliable)
                const scriptTags = doc.querySelectorAll('script[type="application/ld+json"]');
                for (let script of scriptTags) {
                    try {
                        const json = JSON.parse(script.textContent);
                        if (json['@type'] === 'Recipe' || (Array.isArray(json) && json.some(j => j['@type'] === 'Recipe'))) {
                            return extractRecipeFromJsonLd(json);
                        }
                    } catch (e) {
                        // Continue to next script tag
                    }
                }

                // Fallback: Try to extract from Open Graph meta tags and common HTML patterns
                return extractRecipeFromHTML(doc, url);

            } catch (error) {
                console.error('Parse error:', error);
                return null;
            }
        }

        function extractRecipeFromJsonLd(jsonLd) {
            let recipe = Array.isArray(jsonLd) ? jsonLd.find(j => j['@type'] === 'Recipe') : jsonLd;
            if (!recipe) return null;

            const ingredients = [];
            if (recipe.recipeIngredient && Array.isArray(recipe.recipeIngredient)) {
                recipe.recipeIngredient.forEach(ing => {
                    const parsed = parseIngredientString(ing);
                    if (parsed) ingredients.push(parsed);
                });
            }

            const steps = [];
            if (recipe.recipeInstructions) {
                if (Array.isArray(recipe.recipeInstructions)) {
                    recipe.recipeInstructions.forEach(step => {
                        if (typeof step === 'string') {
                            steps.push(step.trim());
                        } else if (step.text) {
                            steps.push(step.text.trim());
                        }
                    });
                } else if (typeof recipe.recipeInstructions === 'string') {
                    recipe.recipeInstructions.split(/[.!?]+/).forEach(step => {
                        const trimmed = step.trim();
                        if (trimmed) steps.push(trimmed);
                    });
                }
            }

            return {
                name: recipe.name || 'Imported Cocktail',
                category: determineCategory(recipe.name),
                baseSpirit: extractBaseSpirit(ingredients),
                ingredients: ingredients.slice(0, 10), // Limit to 10 ingredients
                steps: steps.slice(0, 15), // Limit to 15 steps
                source: 'Web Import',
                image: recipe.image || '',
                color: getRandomCocktailColor()
            };
        }

        function extractRecipeFromHTML(doc, url) {
            let name = '';
            let ingredients = [];
            let steps = [];

            // Try to get recipe name from title or h1
            const titleTag = doc.querySelector('title');
            const h1Tag = doc.querySelector('h1');
            const ogTitle = doc.querySelector('meta[property="og:title"]');
            
            if (h1Tag) name = h1Tag.textContent.trim().split('|')[0];
            else if (ogTitle) name = ogTitle.getAttribute('content');
            else if (titleTag) name = titleTag.textContent.split('|')[0].trim();

            // Try to extract ingredients
            const liItems = doc.querySelectorAll('li');
            liItems.forEach(li => {
                const text = li.textContent.trim();
                if (text.length > 5 && text.length < 100) {
                    const parsed = parseIngredientString(text);
                    if (parsed && ingredients.length < 15) {
                        ingredients.push(parsed);
                    }
                }
            });

            // If we found some potential ingredients, keep them
            // Otherwise try paragraphs
            if (ingredients.length === 0) {
                const pItems = doc.querySelectorAll('p');
                pItems.forEach(p => {
                    const text = p.textContent.trim();
                    if (text.length > 10 && text.length < 200 && steps.length < 10) {
                        steps.push(text);
                    }
                });
            } else {
                // Get steps from paragraphs or divs
                const instructionDivs = doc.querySelectorAll('[class*="instruction"], [class*="step"], [class*="direction"]');
                if (instructionDivs.length > 0) {
                    instructionDivs.forEach(div => {
                        const text = div.textContent.trim();
                        if (text.length > 5 && steps.length < 10) {
                            steps.push(text);
                        }
                    });
                }
            }

            // If we couldn't get instructions, get from paragraphs
            if (steps.length === 0) {
                const pItems = doc.querySelectorAll('p');
                let count = 0;
                pItems.forEach(p => {
                    const text = p.textContent.trim();
                    if (text.length > 20 && text.length < 500 && count < 8) {
                        steps.push(text);
                        count++;
                    }
                });
            }

            return {
                name: name || 'Imported from ' + new URL(url).hostname,
                category: determineCategory(name),
                baseSpirit: extractBaseSpirit(ingredients),
                ingredients: ingredients.slice(0, 15),
                steps: steps.slice(0, 15),
                source: new URL(url).hostname,
                image: '',
                color: getRandomCocktailColor()
            };
        }

        function parseIngredientString(str) {
            // Parse ingredient strings like "2 oz vodka" or "1/2 cup lemon juice"
            const match = str.match(/^[\d\s./]*\s*(oz|ml|cup|tbsp|tsp|dash|pinch|drop|splash|ounce|milliliter)?[\s]*(.+)$/i);
            
            if (match) {
                const unit = match[1] || '';
                const name = match[2]?.trim() || '';
                
                if (name.length > 1 && name.length < 50) {
                    const amountMatch = str.match(/^([\d\s./]+)/);
                    const amount = amountMatch ? amountMatch[1].trim() : '';
                    
                    return {
                        name: name,
                        amount: amount || '1',
                        unit: unit || 'oz'
                    };
                }
            }
            return null;
        }

        function extractBaseSpirit(ingredients) {
            const spirits = ['vodka', 'gin', 'rum', 'whiskey', 'tequila', 'brandy', 'mezcal', 'cognac', 'bourbon'];
            for (let ing of ingredients) {
                const nameLower = ing.name.toLowerCase();
                for (let spirit of spirits) {
                    if (nameLower.includes(spirit)) {
                        return spirit.charAt(0).toUpperCase() + spirit.slice(1);
                    }
                }
            }
            return 'Other';
        }

        function determineCategory(name) {
            if (!name) return 'Other';
            const nameLower = name.toLowerCase();
            
            if (nameLower.includes('martini')) return 'Classic';
            if (nameLower.includes('daiquiri')) return 'Classic';
            if (nameLower.includes('margarita')) return 'Tequila';
            if (nameLower.includes('mojito')) return 'Rum';
            if (nameLower.includes('cosmopolitan')) return 'Vodka';
            if (nameLower.includes('manhattan')) return 'Whiskey';
            if (nameLower.includes('sour')) return 'Whiskey';
            if (nameLower.includes('tropical') || nameLower.includes('punch')) return 'Rum';
            if (nameLower.includes('shot')) return 'Shots';
            
            return 'Other';
        }

        function getRandomCocktailColor() {
            return cocktailColors[Math.floor(Math.random() * cocktailColors.length)];
        }

        // Close URL import modal on outside click
        document.getElementById('importUrlModal').addEventListener('click', (e) => {
            if (e.target.id === 'importUrlModal') {
                closeImportUrlModal();
            }
        });

        // Close modal on outside click
        document.getElementById('cocktailModal').addEventListener('click', (e) => {
            if (e.target.id === 'cocktailModal') {
                closeModal();
            }
        });

        // Initialize app
        loadTheme();
        init();
    </script>
</body>
</html>
