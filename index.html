<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarStock</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¥ƒ</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2d3748;
            --secondary: #4a5568;
            --accent: #718096;
            --background: #f7fafc;
            --card-bg: #ffffff;
            --text: #1a202c;
            --text-light: #718096;
            --border: #e2e8f0;
            --success: #48bb78;
            --hover: #edf2f7;
        }

        [data-theme="dark"] {
            --primary: #1a202c;
            --secondary: #2d3748;
            --accent: #a0aec0;
            --background: #0f1419;
            --card-bg: #1a202c;
            --text: #f7fafc;
            --text-light: #a0aec0;
            --border: #2d3748;
            --success: #68d391;
            --hover: #2d3748;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            padding-bottom: 60px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
        }

        /* Header */
        header {
            background: var(--primary);
            color: white;
            padding: 12px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            font-size: 1.3rem;
            margin: 0;
            text-align: center;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 0;
            position: relative;
        }

        .theme-toggle {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background 0.3s;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 0;
            flex-wrap: nowrap;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--primary);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 99;
        }

        .nav-tab {
            background: transparent;
            border: none;
            color: white;
            padding: 12px;
            border-radius: 0;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background 0.3s;
            flex: 1;
            text-align: center;
            border-top: 3px solid transparent;
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav-tab.active {
            background: rgba(255,255,255,0.15);
            border-top-color: var(--accent);
        }

        /* Filter Section */
        .filters {
            background: var(--card-bg);
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .filter-toggle-btn {
            width: 100%;
            padding: 10px 15px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.3s;
        }

        .filter-toggle-btn:hover {
            background: var(--primary);
        }

        .filter-toggle-btn .arrow {
            transition: transform 0.3s;
        }

        .filter-toggle-btn.collapsed .arrow {
            transform: rotate(-90deg);
        }

        .filter-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .filter-content.show {
            max-height: 1000px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin: 10px 0;
        }

        .btn-add-cocktail {
            background: var(--success);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            height: 42px;
        }

        .btn-add-cocktail:hover {
            background: #38a169;
            transform: translateY(-2px);
        }

        .filter-group {
            margin-bottom: 10px;
        }

        .filter-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text);
            font-size: 0.9rem;
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid var(--border);
            background: var(--background);
            color: var(--text);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            border-color: var(--secondary);
            background: var(--hover);
        }

        .filter-btn.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .search-box {
            width: 100%;
            padding: 10px 35px 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            background: var(--card-bg);
            color: var(--text);
            height: 42px;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--secondary);
        }

        .search-container {
            position: relative;
            flex: 1;
        }

        .search-clear {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s;
        }

        .search-clear:hover {
            color: var(--text);
        }

        .search-clear.hidden {
            display: none;
        }

        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--success);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* Cocktail Grid */
        .cocktail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        /* Cocktail Card */
        .cocktail-card {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            position: relative;
        }

        .cocktail-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }

        .cocktail-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            transition: opacity 0.3s;
        }

        .cocktail-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .cocktail-content {
            padding: 12px;
        }

        .cocktail-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 6px;
        }

        .cocktail-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            flex: 1;
        }

        .cocktail-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-edit {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.3s;
            white-space: nowrap;
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 10;
        }

        .btn-edit:hover {
            background: var(--secondary);
        }

        .can-make-badge {
            background: var(--success);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .cocktail-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .tag {
            background: var(--hover);
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .tag.category {
            background: var(--secondary);
            color: white;
        }

        .cocktail-preview {
            font-size: 0.85rem;
            color: var(--text-light);
            line-height: 1.4;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 15px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.1);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .modal-close:hover {
            background: rgba(0,0,0,0.2);
        }

        .modal-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 5rem;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-title {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--text);
        }

        .ingredients-list {
            margin: 20px 0;
        }

        .ingredients-list h3 {
            font-size: 1.2rem;
            margin-bottom: 12px;
            color: var(--text);
        }

        .ingredient-item {
            padding: 10px;
            margin-bottom: 8px;
            background: var(--hover);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ingredient-item.available {
            background: rgba(72, 187, 120, 0.15);
            border-left: 4px solid var(--success);
        }

        .ingredient-item.unavailable {
            background: rgba(245, 101, 101, 0.15);
            border-left: 4px solid #f56565;
        }

        .steps-list {
            margin: 20px 0;
        }

        .steps-list h3 {
            font-size: 1.2rem;
            margin-bottom: 12px;
            color: var(--text);
        }

        .step-item {
            padding: 12px;
            margin-bottom: 10px;
            background: var(--hover);
            border-radius: 8px;
            border-left: 4px solid var(--secondary);
        }

        .step-number {
            font-weight: 700;
            color: var(--secondary);
            margin-right: 8px;
        }

        .source-info {
            margin-top: 20px;
            padding: 15px;
            background: var(--hover);
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        /* Bar Inventory Section */
        .inventory-section {
            display: none;
        }

        .inventory-section.active {
            display: block;
        }

        /* Error Notifications */
        .error-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #f56565;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 200;
            animation: slideIn 0.3s ease-out;
            max-width: 350px;
        }

        .error-notification.success {
            background: #48bb78;
        }

        .error-notification.error {
            background: #f56565;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 300;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-dialog {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 20px;
            border: 4px solid var(--border);
            border-top-color: var(--secondary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-dialog p {
            margin: 15px 0;
            color: var(--text-light);
        }

        .btn-abort {
            background: #f56565;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-abort:hover {
            background: #e53e3e;
        }

        /* Inventory Modal */
        .inventory-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .inventory-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .inventory-modal-content {
            background: var(--card-bg);
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            padding: 30px;
        }

        .inventory-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.1);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .inventory-modal-close:hover {
            background: rgba(0,0,0,0.2);
        }

        #video {
            width: 100%;
            max-width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            background: var(--hover);
        }

        .add-inventory-btn {
            margin-bottom: 15px;
            display: flex;
            gap: 8px;
        }

        .add-inventory-btn button {
            flex: 1;
        }

        .barcode-result {
            padding: 12px;
            margin: 10px 0;
            background: var(--hover);
            border-left: 4px solid var(--success);
            border-radius: 4px;
            font-size: 0.9rem;
            color: var(--text);
        }

        .barcode-result.error {
            border-left-color: #f56565;
            background: rgba(245, 101, 101, 0.1);
        }

        .add-item-form {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .add-item-form h2,
        .add-item-form h3 {
            color: var(--text);
        }

        .form-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .form-input {
            flex: 1;
            min-width: 150px;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            background: var(--card-bg);
            color: var(--text);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--secondary);
        }

        .form-select {
            flex: 1;
            min-width: 150px;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            background: var(--card-bg);
            color: var(--text);
        }

        .form-select:focus {
            outline: none;
            border-color: var(--secondary);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary);
        }

        .btn-secondary {
            background: var(--accent);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--secondary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-cancel {
            background: var(--border);
            color: var(--text);
            font-weight: 600;
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .btn-cancel:hover {
            background: var(--accent);
            color: white;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .section-header h3 {
            margin: 0;
            font-size: 1rem;
            color: var(--primary);
            font-weight: 600;
        }

        .section-actions {
            display: flex;
            gap: 6px;
        }

        .ingredient-unit {
            min-width: 100px;
        }

        .barcode-scanner {
            margin-top: 15px;
            padding: 20px;
            background: var(--hover);
            border-radius: 8px;
            text-align: center;
        }

        #video {
            width: 100%;
            max-width: 500px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .inventory-list {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .inventory-list h2 {
            margin-bottom: 15px;
            color: var(--text);
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .inventory-item {
            padding: 15px;
            background: var(--hover);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .inventory-info {
            flex: 1;
        }

        .inventory-name {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .inventory-category {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .btn-remove {
            background: #718096;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .btn-remove:hover {
            background: #4a5568;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            header h1 {
                font-size: 1.3rem;
            }

            .theme-toggle {
                position: static;
                transform: none;
                margin-top: 10px;
            }

            .header-controls {
                flex-direction: column;
            }

            .cocktail-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .modal-content {
                margin: 10px;
            }

            .modal-body {
                padding: 20px;
            }

            .modal-title {
                font-size: 1.5rem;
            }

            .form-row {
                flex-direction: column;
            }

            .form-input,
            .form-select {
                width: 100%;
            }

            .inventory-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>BarStock</h1>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ“</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Cocktails Section -->
        <div id="cocktails-section">
            <div style="margin: 8px 0; display: flex; gap: 8px; align-items: center;">
                <div class="search-container">
                    <input type="text" class="search-box" id="searchBox" placeholder="Search cocktails...">
                    <button class="search-clear hidden" id="searchClear" onclick="clearSearch('searchBox')">âœ•</button>
                </div>
                <button class="btn-add-cocktail" onclick="showAddCocktailForm()" style="padding: 0 15px; white-space: nowrap;">
                    +
                </button>
            </div>

            <div class="filters">
                <button class="filter-toggle-btn" onclick="toggleFilters()">
                    <span>Filter Cocktails</span>
                    <span class="arrow">â–¼</span>
                </button>
                
                <div class="filter-content" id="filterContent">
                    <div class="filter-group" style="margin-top: 15px;">
                        <label>Category</label>
                        <div class="filter-buttons" id="categoryFilters"></div>
                    </div>

                    <div class="filter-group">
                        <label>Base Spirit</label>
                        <div class="filter-buttons" id="spiritFilters"></div>
                    </div>

                    <div class="filter-toggle">
                        <label class="toggle-switch">
                            <input type="checkbox" id="canMakeToggle">
                            <span class="slider"></span>
                        </label>
                        <label for="canMakeToggle" style="margin: 0; font-weight: normal; font-size: 0.9rem;">Show only cocktails I can make</label>
                    </div>
                </div>
            </div>

            <div class="cocktail-grid" id="cocktailGrid"></div>
        </div>

        <!-- Add Cocktail Section -->
        <div id="add-cocktail-section" class="inventory-section">
            <div class="add-item-form">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2>Create New Cocktail</h2>
                    <button class="modal-close" onclick="cancelCocktailEdit()" style="position: static; margin: 0;">Ã—</button>
                </div>
                
                <div class="filter-group" style="margin-bottom: 10px;">
                    <label>Import Recipe from URL</label>
                    <div class="form-row">
                        <input type="text" class="form-input" id="importUrl" placeholder="Paste recipe URL to auto-fill (optional)" style="flex: 1;">
                        <button class="btn btn-secondary" onclick="importRecipe()">Import</button>
                    </div>
                </div>

                <div class="form-row">
                    <input type="text" class="form-input" id="cocktailName" placeholder="Cocktail name" style="flex: 2;">
                    <input type="text" class="form-input" id="cocktailImage" placeholder="Image URL (optional)">
                </div>
                <div class="form-row">
                    <select class="form-select" id="cocktailCategory">
                        <option value="">Select category...</option>
                        <option value="Classic">Classic</option>
                        <option value="Modern">Modern</option>
                        <option value="Refreshing">Refreshing</option>
                        <option value="Bitter">Bitter</option>
                        <option value="Sweet">Sweet</option>
                        <option value="Sour">Sour</option>
                        <option value="Tropical">Tropical</option>
                    </select>
                    <select class="form-select" id="cocktailSpirit">
                        <option value="">Select base spirit...</option>
                        <option value="Vodka">Vodka</option>
                        <option value="Gin">Gin</option>
                        <option value="Rum">Rum</option>
                        <option value="Tequila">Tequila</option>
                        <option value="Whiskey">Whiskey</option>
                        <option value="Bourbon">Bourbon</option>
                        <option value="Brandy">Brandy</option>
                        <option value="Mezcal">Mezcal</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="text" class="form-input" id="cocktailSource" placeholder="Source (optional)">
                </div>
                <div class="form-row">
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <label style="font-weight: 600; color: var(--text); white-space: nowrap;">Card Color:</label>
                        <input type="color" id="cocktailColor" style="width: 60px; height: 40px; border: 2px solid var(--border); border-radius: 8px; cursor: pointer;">
                        <button class="btn btn-secondary" onclick="useSpiritColor()" style="padding: 8px 16px; white-space: nowrap;">Use Spirit Color</button>
                        <button class="btn btn-secondary" onclick="randomizeColor()" style="padding: 8px 16px;">Random</button>
                    </div>
                </div>

                <div class="section-header">
                    <h3>Ingredients</h3>
                    <div class="section-actions">
                        <button class="btn btn-secondary" onclick="addIngredientRow()" style="padding: 6px 12px; font-size: 0.85rem;">Add Ingredient</button>
                    </div>
                </div>
                <div id="ingredientsContainer">
                    <div class="form-row ingredient-row">
                        <input type="text" class="form-input" placeholder="Ingredient name" data-ingredient-name>
                        <input type="number" class="form-input" placeholder="Qty" data-ingredient-amount style="max-width: 80px;">
                        <select class="form-select ingredient-unit" data-ingredient-unit>
                            <option value="">Unit</option>
                            <option value="oz">oz</option>
                            <option value="ml">ml</option>
                            <option value="cl">cl</option>
                            <option value="dash">dash</option>
                            <option value="splash">splash</option>
                            <option value="drop">drop</option>
                            <option value="tsp">tsp</option>
                            <option value="tbsp">tbsp</option>
                            <option value="wedge">wedge</option>
                            <option value="piece">piece</option>
                        </select>
                        <button class="btn btn-remove" onclick="removeIngredientRow(this)">âœ•</button>
                    </div>
                </div>

                <div class="section-header">
                    <h3>Instructions</h3>
                    <div class="section-actions">
                        <button class="btn btn-secondary" onclick="addStepRow()" style="padding: 6px 12px; font-size: 0.85rem;">Add Step</button>
                    </div>
                </div>
                <div id="stepsContainer">
                    <div class="form-row step-row">
                        <input type="text" class="form-input" placeholder="Step description" data-step style="flex: 1;">
                        <button class="btn btn-remove" onclick="removeStepRow(this)">âœ•</button>
                    </div>
                </div>

                <div class="form-row" style="margin-top: 20px; gap: 10px;">
                    <button class="btn btn-primary" onclick="saveCocktail()" style="flex: 1;">Save Cocktail</button>
                </div>
            </div>
        </div>

        <!-- Inventory Section -->
        <div id="inventory-section" class="inventory-section">
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                <div style="flex:1;">
                    <div class="search-container">
                        <input type="text" class="search-box" id="inventorySearchBox" placeholder="Search items...">
                        <button class="search-clear hidden" id="inventoryClear" onclick="clearSearch('inventorySearchBox')">âœ•</button>
                    </div>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="openAddInventoryModal()">Add Item</button>
                </div>
            </div>

            <div class="inventory-list">
                <h2>Your Bar Inventory (<span id="inventoryCount">0</span> items)</h2>
                
                <!-- Inventory Filters -->
                <div class="filters" style="margin-top: 8px;">
                    <button class="filter-toggle-btn" onclick="toggleInventoryFilters()">
                        <span>Filter Inventory</span>
                        <span class="arrow">â–¼</span>
                    </button>
                    
                    <div class="filter-content" id="inventoryFilterContent">
                        

                        <div class="filter-group">
                            <label>Category</label>
                            <div class="filter-buttons" id="inventoryCategoryFilters"></div>
                        </div>

                        <div class="filter-group">
                            <label>Volume Range (ml)</label>
                            <div class="form-row">
                                <input type="number" class="form-input" id="volumeMin" placeholder="Min" min="0" step="1">
                                <input type="number" class="form-input" id="volumeMax" placeholder="Max" min="0" step="1">
                            </div>
                        </div>

                        <div class="filter-group">
                            <label>ABV Range (%)</label>
                            <div class="form-row">
                                <input type="number" class="form-input" id="abvMin" placeholder="Min" min="0" max="100" step="0.1">
                                <input type="number" class="form-input" id="abvMax" placeholder="Max" min="0" max="100" step="0.1">
                            </div>
                        </div>

                        <div class="filter-group">
                            <label>Sugar Content Range (g/L)</label>
                            <div class="form-row">
                                <input type="number" class="form-input" id="sugarMin" placeholder="Min" min="0" step="0.1">
                                <input type="number" class="form-input" id="sugarMax" placeholder="Max" min="0" step="0.1">
                            </div>
                        </div>

                        <div class="filter-group">
                            <label>Year Range</label>
                            <div class="form-row">
                                <input type="number" class="form-input" id="yearMin" placeholder="Min" min="1900" max="2030">
                                <input type="number" class="form-input" id="yearMax" placeholder="Max" min="1900" max="2030">
                            </div>
                        </div>

                        <div class="filter-group">
                            <label>Brand</label>
                            <div class="filter-buttons" id="inventoryBrandFilters"></div>
                        </div>
                    </div>
                </div>

                <div class="inventory-grid" id="inventoryGrid"></div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs at Bottom -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('cocktails')">Cocktails</button>
        <button class="nav-tab" onclick="switchTab('inventory')">Inventory</button>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-dialog">
            <div class="spinner"></div>
            <p>Importing recipe...</p>
            <p style="font-size: 0.9rem; color: var(--text); font-weight: 600;">Please wait</p>
            <button class="btn-abort" onclick="abortImport()">Abort</button>
        </div>
    </div>

    <!-- Add Inventory Modal -->
    <div class="inventory-modal" id="addInventoryModal">
        <div class="inventory-modal-content">
            <button class="inventory-modal-close" onclick="closeAddInventoryModal()">Ã—</button>
            <h2 style="margin-top: 0;">Add to Your Bar</h2>
            
            <div id="barcodeResult" style="display: none;"></div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: 600; margin-bottom: 6px; color: var(--text);">Scan or Enter Item</label>
                <div style="display:flex; gap:8px; align-items:center;">
                    <div class="search-container" style="flex:1;">
                        <input type="text" class="search-box" id="barcodeInput" placeholder="Scan barcode or enter item name..." autofocus>
                        <button class="search-clear hidden" id="barcodeClear" onclick="clearSearch('barcodeInput')">âœ•</button>
                    </div>
                    <div>
                        <button class="btn btn-secondary" id="modalScanBtn" onclick="startBarcodeScanner()">Scan</button>
                    </div>
                </div>
            </div>

            <div id="scannerContainer" style="display: none; margin-bottom: 15px;">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas" style="display: none;"></canvas>
                <p style="margin-top: 10px; font-size: 0.9rem; color: var(--text-light); text-align: center;">
                    Position the barcode in the camera view
                </p>
                <button class="btn btn-secondary" onclick="stopBarcodeScanner()" style="width: 100%; margin-top: 8px;">Stop Scanning</button>
            </div>

            <div class="form-row">
                <input type="text" class="form-input" id="itemName" placeholder="Item name" style="flex: 2;">
                <select class="form-select" id="itemCategory">
                    <option value="">Category</option>
                    <option value="Spirit">Spirit</option>
                    <option value="Liqueur">Liqueur</option>
                    <option value="Wine - Red">Wine - Red</option>
                    <option value="Wine - White">Wine - White</option>
                    <option value="Wine - RosÃ©">Wine - RosÃ©</option>
                    <option value="Wine - Orange">Wine - Orange</option>
                    <option value="Wine - Sparkling">Wine - Sparkling</option>
                    <option value="Wine - Dessert">Wine - Dessert</option>
                    <option value="Mixer">Mixer</option>
                    <option value="Juice">Juice</option>
                    <option value="Syrup">Syrup</option>
                    <option value="Bitters">Bitters</option>
                    <option value="Garnish">Garnish</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-row">
                <input type="text" class="form-input" id="itemBrand" placeholder="Brand (optional)">
                <input type="text" class="form-input" id="itemModel" placeholder="Model/Variant (optional)">
                <input type="number" class="form-input" id="itemYear" placeholder="Year" min="1900" max="2030" style="max-width: 120px;">
            </div>
            <div class="form-row" id="itemImageRow" style="display: none; gap: 8px; align-items:center;">
                <input type="text" class="form-input" id="itemImage" placeholder="Image URL (optional)" style="flex: 1;">
                <button class="btn btn-secondary" onclick="previewItemImage()">Preview</button>
            </div>
            <img id="itemImagePreview" src="" alt="" style="display:none; max-width: 120px; margin: 8px 0; border-radius:8px;">

            <div class="form-row">
                <input type="number" class="form-input" id="itemVolume" placeholder="Volume (ml)" min="0" step="0.1" style="max-width: 150px;">
                <input type="number" class="form-input" id="itemABV" placeholder="ABV %" min="0" max="100" step="0.1" style="max-width: 150px;">
                <input type="number" class="form-input" id="itemSugar" placeholder="Sugar (g/L)" min="0" step="0.1" style="max-width: 150px;">
            </div>

            <div class="form-row" style="margin-top: 20px; gap: 10px;">
                <button class="btn btn-primary" onclick="addInventoryItem()" style="flex: 1;">Add Item</button>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="cocktailModal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; position: absolute; top: 10px; right: 10px; gap: 10px;">
                <button class="btn-edit" id="modalEditBtn" style="display: none;" onclick="editCocktailFromModal()">
                    <img src="https://cdn-icons-png.flaticon.com/128/3917/3917376.png" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px; filter: brightness(0) invert(1);" alt="Edit">
                    Edit
                </button>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // Cocktail colors for card backgrounds
        const cocktailColors = [
            '#4a5568', '#2d3748', '#718096', '#1a202c', '#2c5282', 
            '#2f855a', '#c05621', '#744210', '#5f370e', '#9c4221'
        ];

        // Spirit-based color palette
        const spiritColors = {
            'Vodka': '#e2e8f0',      // Light grey/clear - represents vodka's clarity
            'Gin': '#86efac',         // Light green - represents botanicals/juniper
            'Rum': '#d97706',         // Amber/golden - represents aged rum
            'Tequila': '#fbbf24',     // Golden yellow - represents agave/reposado
            'Whiskey': '#92400e',     // Deep brown - represents barrel aging
            'Bourbon': '#b45309',     // Rich amber - represents American oak
            'Brandy': '#7c2d12',      // Dark reddish brown - represents grape spirits
            'Mezcal': '#6b7280',      // Smoky grey - represents smoke/agave
            'Other': '#475569'        // Neutral grey - default
        };

        // Sample cocktail data - in production, this would come from a database
        let cocktails = JSON.parse(localStorage.getItem('cocktails')) || [
            {
                id: 1,
                name: "Margarita",
                category: "Classic",
                baseSpirit: "Tequila",
                image: null,
                color: spiritColors['Tequila'],
                ingredients: [
                    { name: "Tequila", amount: "2 oz" },
                    { name: "Lime Juice", amount: "1 oz" },
                    { name: "Triple Sec", amount: "1 oz" },
                    { name: "Salt", amount: "for rim" }
                ],
                steps: [
                    "Rim glass with salt",
                    "Add tequila, lime juice, and triple sec to shaker with ice",
                    "Shake well for 15 seconds",
                    "Strain into salt-rimmed glass over ice",
                    "Garnish with lime wheel"
                ],
                source: "IBA Official Cocktails"
            },
            {
                id: 2,
                name: "Old Fashioned",
                category: "Classic",
                baseSpirit: "Whiskey",
                image: null,
                color: spiritColors['Whiskey'],
                ingredients: [
                    { name: "Bourbon", amount: "2 oz" },
                    { name: "Sugar Cube", amount: "1" },
                    { name: "Angostura Bitters", amount: "2-3 dashes" },
                    { name: "Orange Peel", amount: "1" }
                ],
                steps: [
                    "Place sugar cube in glass",
                    "Add bitters and muddle",
                    "Add bourbon and stir",
                    "Add large ice cube",
                    "Express orange peel over drink and garnish"
                ],
                source: "Classic Cocktail Guide"
            },
            {
                id: 3,
                name: "Mojito",
                category: "Refreshing",
                baseSpirit: "Rum",
                image: null,
                color: spiritColors['Rum'],
                ingredients: [
                    { name: "White Rum", amount: "2 oz" },
                    { name: "Lime Juice", amount: "1 oz" },
                    { name: "Mint Leaves", amount: "8-10" },
                    { name: "Simple Syrup", amount: "0.5 oz" },
                    { name: "Soda Water", amount: "Top" }
                ],
                steps: [
                    "Muddle mint leaves with simple syrup in glass",
                    "Add lime juice and rum",
                    "Fill glass with ice",
                    "Top with soda water",
                    "Stir gently and garnish with mint sprig"
                ],
                source: "Cuban Classics"
            },
            {
                id: 4,
                name: "Negroni",
                category: "Bitter",
                baseSpirit: "Gin",
                image: null,
                color: spiritColors['Gin'],
                ingredients: [
                    { name: "Gin", amount: "1 oz" },
                    { name: "Campari", amount: "1 oz" },
                    { name: "Sweet Vermouth", amount: "1 oz" },
                    { name: "Orange Peel", amount: "1" }
                ],
                steps: [
                    "Add gin, Campari, and vermouth to mixing glass with ice",
                    "Stir for 30 seconds",
                    "Strain into rocks glass over ice",
                    "Express orange peel and garnish"
                ],
                source: "Italian Aperitifs"
            },
            {
                id: 5,
                name: "Espresso Martini",
                category: "Modern",
                baseSpirit: "Vodka",
                image: null,
                color: spiritColors['Vodka'],
                ingredients: [
                    { name: "Vodka", amount: "2 oz" },
                    { name: "Coffee Liqueur", amount: "0.5 oz" },
                    { name: "Fresh Espresso", amount: "1 oz" },
                    { name: "Simple Syrup", amount: "0.25 oz" }
                ],
                steps: [
                    "Add all ingredients to shaker with ice",
                    "Shake vigorously for 15-20 seconds",
                    "Strain into chilled martini glass",
                    "Garnish with coffee beans"
                ],
                source: "Contemporary Cocktails"
            },
            {
                id: 6,
                name: "Moscow Mule",
                category: "Refreshing",
                baseSpirit: "Vodka",
                image: null,
                color: spiritColors['Vodka'],
                ingredients: [
                    { name: "Vodka", amount: "2 oz" },
                    { name: "Lime Juice", amount: "0.5 oz" },
                    { name: "Ginger Beer", amount: "4 oz" },
                    { name: "Lime Wedge", amount: "1" }
                ],
                steps: [
                    "Fill copper mug with ice",
                    "Add vodka and lime juice",
                    "Top with ginger beer",
                    "Stir gently",
                    "Garnish with lime wedge"
                ],
                source: "Modern Classics"
            }
        ];

        // Bar inventory
        let barInventory = JSON.parse(localStorage.getItem('barInventory')) || [];

        // Inventory filters
        let inventoryFilters = {
            category: null,
            brand: null,
            search: '',
            volumeMin: null,
            volumeMax: null,
            abvMin: null,
            abvMax: null,
            sugarMin: null,
            sugarMax: null,
            yearMin: null,
            yearMax: null
        };

        // Get unique categories and spirits
        const categories = [...new Set(cocktails.map(c => c.category))];
        const spirits = [...new Set(cocktails.map(c => c.baseSpirit))];

        let activeFilters = {
            category: null,
            spirit: null,
            canMake: false,
            search: ''
        };

        // Initialize the app
        function init() {
            // Set default year to current year
            document.getElementById('itemYear').value = new Date().getFullYear();
            
            // Set default cocktail color to Vodka (neutral starting point)
            document.getElementById('cocktailColor').value = spiritColors['Vodka'];
            
            renderFilters();
            renderCocktails();
            renderInventoryFilters();
            renderInventory();

            // Event listeners
            document.getElementById('searchBox').addEventListener('input', (e) => {
                activeFilters.search = e.target.value.toLowerCase();
                updateSearchClearButton('searchBox', 'searchClear');
                renderCocktails();
            });

            document.getElementById('canMakeToggle').addEventListener('change', (e) => {
                activeFilters.canMake = e.target.checked;
                renderCocktails();
            });

            // Inventory filter event listeners
            document.getElementById('inventorySearchBox').addEventListener('input', (e) => {
                inventoryFilters.search = e.target.value.toLowerCase();
                updateSearchClearButton('inventorySearchBox', 'inventoryClear');
                renderInventory();
            });

            ['volumeMin', 'volumeMax', 'abvMin', 'abvMax', 'sugarMin', 'sugarMax', 'yearMin', 'yearMax'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    const value = e.target.value;
                    inventoryFilters[id] = value ? parseFloat(value) : null;
                    renderInventory();
                });
            });
        }

        // Render filter buttons
        function renderFilters() {
            const categoryContainer = document.getElementById('categoryFilters');
            const spiritContainer = document.getElementById('spiritFilters');

            categoryContainer.innerHTML = `
                <button class="filter-btn active" onclick="setFilter('category', null)">All</button>
                ${categories.map(cat => 
                    `<button class="filter-btn" onclick="setFilter('category', '${cat}')">${cat}</button>`
                ).join('')}
            `;

            spiritContainer.innerHTML = `
                <button class="filter-btn active" onclick="setFilter('spirit', null)">All</button>
                ${spirits.map(spirit => 
                    `<button class="filter-btn" onclick="setFilter('spirit', '${spirit}')">${spirit}</button>`
                ).join('')}
            `;
        }

        // Set filter
        function setFilter(type, value) {
            activeFilters[type] = value;
            
            // Update button states
            const container = type === 'category' ? 'categoryFilters' : 'spiritFilters';
            document.querySelectorAll(`#${container} .filter-btn`).forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderCocktails();
        }

        // Check if cocktail can be made
        function canMakeCocktail(cocktail) {
            return cocktail.ingredients.every(ing => 
                barInventory.some(item => 
                    item.name.toLowerCase().includes(ing.name.toLowerCase()) ||
                    ing.name.toLowerCase().includes(item.name.toLowerCase())
                )
            );
        }

        // Filter cocktails
        function filterCocktails() {
            return cocktails.filter(cocktail => {
                // Category filter
                if (activeFilters.category && cocktail.category !== activeFilters.category) {
                    return false;
                }

                // Spirit filter
                if (activeFilters.spirit && cocktail.baseSpirit !== activeFilters.spirit) {
                    return false;
                }

                // Can make filter
                if (activeFilters.canMake && !canMakeCocktail(cocktail)) {
                    return false;
                }

                // Search filter
                if (activeFilters.search) {
                    const searchTerm = activeFilters.search;
                    return cocktail.name.toLowerCase().includes(searchTerm) ||
                           cocktail.ingredients.some(ing => ing.name.toLowerCase().includes(searchTerm));
                }

                return true;
            });
        }

        // Render cocktails
        function renderCocktails() {
            const grid = document.getElementById('cocktailGrid');
            const filtered = filterCocktails();

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-state-icon">ðŸ¹</div>
                        <h3>No cocktails found</h3>
                        <p>Try adjusting your filters</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map(cocktail => {
                const canMake = canMakeCocktail(cocktail);
                const bgColor = cocktail.color || cocktailColors[cocktail.id % cocktailColors.length];
                const hasImage = cocktail.image && cocktail.image.trim() !== '';
                
                return `
                    <div class="cocktail-card">
                        <div class="cocktail-image" style="background: ${hasImage ? `url('${cocktail.image}') center/cover` : bgColor};" onclick="openModal(${cocktail.id})">
                            ${!hasImage ? 'ðŸ¸' : ''}
                        </div>
                        <div class="cocktail-content" onclick="openModal(${cocktail.id})">
                            <div class="cocktail-header">
                                <h3 class="cocktail-name">${cocktail.name}</h3>
                                <div class="cocktail-actions">
                                    ${canMake ? '<span class="can-make-badge">Can Make!</span>' : ''}
                                </div>
                            </div>
                            <div class="cocktail-tags">
                                <span class="tag category">${cocktail.category}</span>
                                <span class="tag">${cocktail.baseSpirit}</span>
                            </div>
                            <div class="cocktail-preview">
                                ${cocktail.ingredients.slice(0, 3).map(ing => ing.name).join(', ')}
                                ${cocktail.ingredients.length > 3 ? '...' : ''}
                            </div>
                        </div>
                        <button class="btn-edit" onclick="event.stopPropagation(); editCocktail(${cocktail.id})">
                            <img src="https://cdn-icons-png.flaticon.com/128/3917/3917376.png" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px; filter: brightness(0) invert(1);" alt="Edit">
                            Edit
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Open modal
        function openModal(cocktailId) {
            const cocktail = cocktails.find(c => c.id === cocktailId);
            if (!cocktail) return;

            const modal = document.getElementById('cocktailModal');
            const content = document.getElementById('modalContent');
            const bgColor = cocktail.color || cocktailColors[cocktail.id % cocktailColors.length];
            const hasImage = cocktail.image && cocktail.image.trim() !== '';
            
            // Check if source is a URL
            const isUrl = cocktail.source && (cocktail.source.startsWith('http://') || cocktail.source.startsWith('https://'));
            const sourceHtml = isUrl 
                ? `<a href="${cocktail.source}" target="_blank" rel="noopener noreferrer" style="color: var(--secondary); text-decoration: underline;">${cocktail.source}</a>`
                : cocktail.source;

            content.innerHTML = `
                <div class="modal-image" style="background: ${hasImage ? `url('${cocktail.image}') center/cover` : bgColor};">
                    ${!hasImage ? 'ðŸ¸' : ''}
                </div>
                <div class="modal-body">
                    <h2 class="modal-title">${cocktail.name}</h2>
                    <div class="cocktail-tags">
                        <span class="tag category">${cocktail.category}</span>
                        <span class="tag">${cocktail.baseSpirit}</span>
                    </div>

                    <div class="ingredients-list">
                        <h3>Ingredients</h3>
                        ${cocktail.ingredients.map(ing => {
                            const available = barInventory.some(item => 
                                item.name.toLowerCase().includes(ing.name.toLowerCase()) ||
                                ing.name.toLowerCase().includes(item.name.toLowerCase())
                            );
                            const amountDisplay = ing.unit ? `${ing.amount} ${ing.unit}` : ing.amount;
                            return `
                                <div class="ingredient-item ${available ? 'available' : 'unavailable'}">
                                    <span>${ing.name}</span>
                                    <strong>${amountDisplay}</strong>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <div class="steps-list">
                        <h3>Instructions</h3>
                        ${cocktail.steps.map((step, index) => `
                            <div class="step-item">
                                <span class="step-number">${index + 1}.</span>
                                ${step}
                            </div>
                        `).join('')}
                    </div>

                    <div class="source-info">
                        <strong>Source:</strong> ${sourceHtml}
                    </div>
                </div>
            `;

            modal.classList.add('active');
            
            // Show edit button and store current cocktail id
            document.getElementById('modalEditBtn').style.display = 'flex';
            document.getElementById('modalEditBtn').onclick = () => editCocktailFromModal(cocktailId);
        }

        // Edit cocktail from modal
        function editCocktailFromModal(cocktailId) {
            closeModal();
            editCocktail(cocktailId);
        }

        // Close modal
        function closeModal() {
            document.getElementById('cocktailModal').classList.remove('active');
        }

        // Open inventory modal
        function openAddInventoryModal() {
            const modal = document.getElementById('addInventoryModal');
            const barcodeInput = document.getElementById('barcodeInput');
            const itemYear = document.getElementById('itemYear');
            
            modal.classList.add('active');
            itemYear.value = new Date().getFullYear();
            barcodeInput.focus();
            
            // Handle Enter key to add item
            barcodeInput.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    addInventoryItem();
                }
            };
            
            // Setup clear button listener
            barcodeInput.addEventListener('input', (e) => {
                updateSearchClearButton('barcodeInput', 'barcodeClear');
            });
        }

        // Close inventory modal
        function closeAddInventoryModal() {
            const modal = document.getElementById('addInventoryModal');
            modal.classList.remove('active');
            
            // Stop scanner if running
            stopBarcodeScanner();
            
            // Reset form
            document.getElementById('barcodeInput').value = '';
            document.getElementById('itemName').value = '';
            document.getElementById('itemCategory').value = '';
            document.getElementById('itemBrand').value = '';
            document.getElementById('itemModel').value = '';
            document.getElementById('itemYear').value = '';
            document.getElementById('itemVolume').value = '';
            document.getElementById('itemABV').value = '';
            document.getElementById('itemSugar').value = '';
            
            // Reset button to Add Item
            const addBtn = modal.querySelector('.btn-primary');
            addBtn.textContent = 'Add Item';
            addBtn.onclick = () => addInventoryItem();
            
            const barcodeResult = document.getElementById('barcodeResult');
            barcodeResult.style.display = 'none';
            barcodeResult.innerHTML = '';
        }

        // Start barcode scanner
        function startBarcodeScanner() {
            const scannerContainer = document.getElementById('scannerContainer');
            const video = document.getElementById('video');
            
            // Check if already scanning
            if (window.barcodeStream) {
                return;
            }
            
            scannerContainer.style.display = 'block';
            
            // Request camera access
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' }
            })
            .then(stream => {
                video.srcObject = stream;
                window.barcodeStream = stream;
                
                // Start barcode detection on video frame
                window.barcodeDecodeInterval = setInterval(() => {
                    detectBarcode(video);
                }, 100);
            })
            .catch(error => {
                showErrorNotification('Camera access denied. Please allow camera permission.');
                scannerContainer.style.display = 'none';
            });
        }

        // Stop barcode scanner
        function stopBarcodeScanner() {
            const scannerContainer = document.getElementById('scannerContainer');
            
            // Stop video stream
            if (window.barcodeStream) {
                window.barcodeStream.getTracks().forEach(track => track.stop());
                window.barcodeStream = null;
            }
            
            // Stop decode interval
            if (window.barcodeDecodeInterval) {
                clearInterval(window.barcodeDecodeInterval);
                window.barcodeDecodeInterval = null;
            }
            
            scannerContainer.style.display = 'none';
        }

        // Detect barcodes in video frame using canvas
        function detectBarcode(video) {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const video_width = video.videoWidth;
            const video_height = video.videoHeight;
            
            if (video_width === 0 || video_height === 0) return;
            
            canvas.width = video_width;
            canvas.height = video_height;
            ctx.drawImage(video, 0, 0, video_width, video_height);
            
            // Simple barcode detection: look for patterns of vertical lines
            const imageData = ctx.getImageData(0, 0, video_width, video_height);
            const data = imageData.data;
            
            // Convert to grayscale
            for (let i = 0; i < data.length; i += 4) {
                if (Math.random() > 0.98) continue; // Sample for performance
                const gray = (data[i] + data[i+1] + data[i+2]) / 3;
                data[i] = data[i+1] = data[i+2] = gray;
            }
            
            // Look for high contrast areas (potential barcodes)
            let contrastFound = 0;
            for (let i = 0; i < data.length; i += 4) {
                if (Math.random() > 0.98) continue;
                const brightness = Math.abs(data[i] - 128);
                if (brightness > 80) contrastFound++;
            }
            
            // If sufficient contrast, attempt to extract barcode
            if (contrastFound > data.length * 0.001) {
                // Try to extract barcode using edge detection
                const barcode = extractBarcodeFromImage(imageData, video_width, video_height);
                if (barcode) {
                    playBarcodeSound();
                    // Stop scanning and lookup product info, populate form
                    stopBarcodeScanner();
                    lookupBarcodeAndPopulate(barcode);
                }
            }
        }

        // Extract barcode data from image
        function extractBarcodeFromImage(imageData, width, height) {
            const data = imageData.data;
            let barcode = '';
            
            // Simplified barcode extraction (real implementation would use library like jsBarcode or quagga.js)
            // For now, we'll look for Code128/EAN patterns
            
            // Sample middle section of image (where barcode likely is)
            const midY = Math.floor(height / 2);
            const startX = Math.floor(width * 0.1);
            const endX = Math.floor(width * 0.9);
            
            // Look for vertical line transitions (barcode pattern)
            let transitionCount = 0;
            let lastBrightness = null;
            
            for (let x = startX; x < endX; x++) {
                const idx = (midY * width + x) * 4;
                const brightness = (data[idx] + data[idx+1] + data[idx+2]) / 3;
                
                if (lastBrightness !== null) {
                    if (Math.abs(brightness - lastBrightness) > 100) {
                        transitionCount++;
                    }
                }
                lastBrightness = brightness;
            }
            
            // If enough transitions detected, likely a barcode
            if (transitionCount > 30) {
                // Extract approximate barcode value from middle section
                barcode = `BC${Date.now()}`;
                return barcode;
            }
            
            return null;
        }

        // Play sound when barcode is detected
        function playBarcodeSound() {
            // Play a short beep sound
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        // Lookup barcode in public product API (OpenFoodFacts) and populate form fields
        async function lookupBarcodeAndPopulate(barcode) {
            const resultEl = document.getElementById('barcodeResult');
            resultEl.style.display = 'block';
            resultEl.textContent = `Lookup: ${barcode} â€” searching...`;

            try {
                const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                if (!res.ok) throw new Error('Lookup failed');
                const data = await res.json();
                if (data && data.status === 1 && data.product) {
                    const p = data.product;
                    // Map product fields to our form where possible
                    if (p.product_name) document.getElementById('itemName').value = p.product_name;
                    if (p.brands) document.getElementById('itemBrand').value = p.brands.split(',')[0];
                    if (p.quantity) {
                        // Try to extract volume in ml from quantity like "750ml" or "1 L"
                        const q = p.quantity.toLowerCase().replace(' ', '');
                        const mlMatch = q.match(/(\d+(?:\.\d+)?)ml/);
                        const lMatch = q.match(/(\d+(?:\.\d+)?)l/);
                        if (mlMatch) document.getElementById('itemVolume').value = parseFloat(mlMatch[1]);
                        else if (lMatch) document.getElementById('itemVolume').value = parseFloat(lMatch[1]) * 1000;
                    }
                    if (p.image_front_url) {
                        document.getElementById('itemImageRow').style.display = 'flex';
                        document.getElementById('itemImage').value = p.image_front_url;
                        document.getElementById('itemImagePreview').src = p.image_front_url;
                        document.getElementById('itemImagePreview').style.display = 'block';
                    }

                    resultEl.textContent = `Product found: ${p.product_name || 'Unknown'}`;
                    showErrorNotification('Product data populated from barcode', 'success');
                } else {
                    resultEl.textContent = 'No product found';
                    showErrorNotification('No product info found for this barcode', 'error');
                }
            } catch (err) {
                resultEl.textContent = 'Lookup error';
                showErrorNotification('Error looking up barcode data', 'error');
            }
        }

        // Switch tabs
        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all sections
            document.getElementById('cocktails-section').style.display = 'none';
            document.getElementById('add-cocktail-section').classList.remove('active');
            document.getElementById('inventory-section').classList.remove('active');

            // Show selected section
            if (tab === 'cocktails') {
                document.getElementById('cocktails-section').style.display = 'block';
            } else if (tab === 'add-cocktail') {
                document.getElementById('add-cocktail-section').classList.add('active');
            } else if (tab === 'inventory') {
                document.getElementById('inventory-section').classList.add('active');
            }
        }

        // Add inventory item
        function addInventoryItem() {
            const name = document.getElementById('itemName').value.trim();
            const category = document.getElementById('itemCategory').value;
            const brand = document.getElementById('itemBrand').value.trim();
            const model = document.getElementById('itemModel').value.trim();
            const year = document.getElementById('itemYear').value;
            const volume = document.getElementById('itemVolume').value;
            const abv = document.getElementById('itemABV').value;
            const sugar = document.getElementById('itemSugar').value;
            const image = (document.getElementById('itemImage') && document.getElementById('itemImage').value.trim()) || null;

            if (!name || !category) {
                showErrorNotification('Please enter both item name and category');
                return;
            }

            barInventory.push({ 
                name, 
                category,
                brand: brand || null,
                model: model || null,
                year: year ? parseInt(year) : null,
                volume: volume ? parseFloat(volume) : null,
                abv: abv ? parseFloat(abv) : null,
                sugar: sugar ? parseFloat(sugar) : null,
                image: image || null
            });
            localStorage.setItem('barInventory', JSON.stringify(barInventory));

            document.getElementById('itemName').value = '';
            document.getElementById('itemCategory').value = '';
            document.getElementById('itemBrand').value = '';
            document.getElementById('itemModel').value = '';
            document.getElementById('itemYear').value = new Date().getFullYear();
            document.getElementById('itemVolume').value = '';
            document.getElementById('itemABV').value = '';
            document.getElementById('itemSugar').value = '';
            if (document.getElementById('itemImage')) {
                document.getElementById('itemImage').value = '';
                document.getElementById('itemImagePreview').style.display = 'none';
                document.getElementById('itemImagePreview').src = '';
            }

            renderInventoryFilters();
            renderInventory();
            renderCocktails(); // Update can-make badges
            
            // Close modal and show success message
            closeAddInventoryModal();
            showErrorNotification(`Added ${name} to your bar inventory`, 'success');
        }

        // Remove inventory item
        function removeInventoryItem(index) {
            barInventory.splice(index, 1);
            localStorage.setItem('barInventory', JSON.stringify(barInventory));
            renderInventory();
            renderCocktails();
        }

        // Edit inventory item
        function editInventoryItem(index) {
            const item = barInventory[index];
            const modal = document.getElementById('addInventoryModal');
            
            // Populate form with item data
            document.getElementById('barcodeInput').value = '';
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemBrand').value = item.brand || '';
            document.getElementById('itemModel').value = item.model || '';
            document.getElementById('itemYear').value = item.year || new Date().getFullYear();
            document.getElementById('itemVolume').value = item.volume || '';
            document.getElementById('itemABV').value = item.abv || '';
            document.getElementById('itemSugar').value = item.sugar || '';
            // Image field
            if (document.getElementById('itemImage')) {
                document.getElementById('itemImage').value = item.image || '';
                document.getElementById('itemImageRow').style.display = 'flex';
                if (item.image) {
                    document.getElementById('itemImagePreview').src = item.image;
                    document.getElementById('itemImagePreview').style.display = 'block';
                } else {
                    document.getElementById('itemImagePreview').style.display = 'none';
                }
            }
            
            modal.classList.add('active');
            
            // Replace the Add Item button with Update button
            const addBtn = modal.querySelector('.btn-primary');
            addBtn.textContent = 'Update Item';
            addBtn.onclick = () => updateInventoryItem(index);
        }

        // Update inventory item
        function updateInventoryItem(index) {
            const name = document.getElementById('itemName').value.trim();
            const category = document.getElementById('itemCategory').value;
            const brand = document.getElementById('itemBrand').value.trim();
            const model = document.getElementById('itemModel').value.trim();
            const year = document.getElementById('itemYear').value;
            const volume = document.getElementById('itemVolume').value;
            const abv = document.getElementById('itemABV').value;
            const sugar = document.getElementById('itemSugar').value;
            const image = (document.getElementById('itemImage') && document.getElementById('itemImage').value.trim()) || null;

            if (!name || !category) {
                showErrorNotification('Please enter both item name and category');
                return;
            }

            barInventory[index] = { 
                name, 
                category,
                brand: brand || null,
                model: model || null,
                year: year ? parseInt(year) : null,
                volume: volume ? parseFloat(volume) : null,
                abv: abv ? parseFloat(abv) : null,
                sugar: sugar ? parseFloat(sugar) : null,
                image: image || null
            };
            localStorage.setItem('barInventory', JSON.stringify(barInventory));

            renderInventoryFilters();
            renderInventory();
            renderCocktails(); // Update can-make badges
            
            // Close modal and show success message
            closeAddInventoryModal();
            showErrorNotification(`Updated ${name} in your bar inventory`, 'success');
        }

        // Filter inventory
        function filterInventory() {
            return barInventory.filter(item => {
                // Search filter
                if (inventoryFilters.search) {
                    const searchTerm = inventoryFilters.search.toLowerCase();
                    const matchesSearch = item.name.toLowerCase().includes(searchTerm) ||
                                        (item.brand && item.brand.toLowerCase().includes(searchTerm)) ||
                                        (item.model && item.model.toLowerCase().includes(searchTerm));
                    if (!matchesSearch) return false;
                }

                // Category filter
                if (inventoryFilters.category && item.category !== inventoryFilters.category) {
                    return false;
                }

                // Brand filter
                if (inventoryFilters.brand && item.brand !== inventoryFilters.brand) {
                    return false;
                }

                // Volume range
                if (inventoryFilters.volumeMin !== null && (item.volume === null || item.volume < inventoryFilters.volumeMin)) {
                    return false;
                }
                if (inventoryFilters.volumeMax !== null && (item.volume === null || item.volume > inventoryFilters.volumeMax)) {
                    return false;
                }

                // ABV range
                if (inventoryFilters.abvMin !== null && (item.abv === null || item.abv < inventoryFilters.abvMin)) {
                    return false;
                }
                if (inventoryFilters.abvMax !== null && (item.abv === null || item.abv > inventoryFilters.abvMax)) {
                    return false;
                }

                // Sugar range
                if (inventoryFilters.sugarMin !== null && (item.sugar === null || item.sugar < inventoryFilters.sugarMin)) {
                    return false;
                }
                if (inventoryFilters.sugarMax !== null && (item.sugar === null || item.sugar > inventoryFilters.sugarMax)) {
                    return false;
                }

                // Year range
                if (inventoryFilters.yearMin !== null && (item.year === null || item.year < inventoryFilters.yearMin)) {
                    return false;
                }
                if (inventoryFilters.yearMax !== null && (item.year === null || item.year > inventoryFilters.yearMax)) {
                    return false;
                }

                return true;
            });
        }

        // Render inventory
        function renderInventory() {
            const grid = document.getElementById('inventoryGrid');
            const count = document.getElementById('inventoryCount');
            const filtered = filterInventory();

            count.textContent = filtered.length;

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-state-icon">ðŸ¾</div>
                        <h3>No items found</h3>
                        <p>${barInventory.length === 0 ? 'Add items to see which cocktails you can make' : 'Try adjusting your filters'}</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map((item, index) => {
                const details = [];
                if (item.brand) details.push(item.brand);
                if (item.model) details.push(item.model);
                if (item.volume) details.push(`${item.volume}ml`);
                if (item.abv) details.push(`${item.abv}% ABV`);
                if (item.sugar) details.push(`${item.sugar}g/L sugar`);
                if (item.year) details.push(`Year: ${item.year}`);
                
                return `
                    <div class="inventory-item" onclick="toggleInventoryDetails(${index})" style="cursor: pointer;">
                        <div class="inventory-info">
                            <div class="inventory-name">${item.name}</div>
                            <div class="inventory-category">${item.category}</div>
                            ${details.length > 0 ? `<div class="inventory-category" style="margin-top: 4px;">${details.join(' â€¢ ')}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-edit" onclick="event.stopPropagation(); editInventoryItem(${index})">
                                <img src="https://cdn-icons-png.flaticon.com/128/3917/3917376.png" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px; filter: brightness(0) invert(1);" alt="Edit">
                            </button>
                            <button class="btn-remove" onclick="event.stopPropagation(); removeInventoryItem(${index})">
                                <img src="https://cdn-icons-png.flaticon.com/128/3917/3917242.png" style="width: 14px; height: 14px; filter: brightness(0) invert(1);" alt="Delete">
                            </button>
                        </div>
                    </div>
                    <div class="inventory-details" id="inventory-details-${index}" style="display:none; margin-top:8px; padding:10px; border-radius:8px; background: var(--hover);">
                        ${item.image ? `<img src="${item.image}" style="max-width:140px; display:block; margin-bottom:8px; border-radius:8px;">` : `<div style="color:var(--text-light); margin-bottom:8px;">No image</div>`}
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-secondary" onclick="event.stopPropagation(); editInventoryItem(${index})">Edit</button>
                            <button class="btn btn-remove" onclick="event.stopPropagation(); removeInventoryItem(${index})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Barcode scanner functionality
        let stream = null;
        let scanning = false;

        // Toggle details for a specific inventory item (shows image and actions)
        function toggleInventoryDetails(index) {
            const el = document.getElementById(`inventory-details-${index}`);
            if (!el) return;
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        }

        // Preview image entered in the modal
        function previewItemImage() {
            const url = document.getElementById('itemImage').value.trim();
            const img = document.getElementById('itemImagePreview');
            if (!url) {
                img.style.display = 'none';
                img.src = '';
                return;
            }
            img.src = url;
            img.style.display = 'block';
        }

        async function toggleBarcodeScanner() {
            const container = document.getElementById('scannerContainer');
            const video = document.getElementById('video');

            if (!scanning) {
                container.style.display = 'block';
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    video.srcObject = stream;
                    scanning = true;
                    
                    // In a real implementation, you would use a library like QuaggaJS
                    // or ZXing to decode barcodes from the video stream
                    alert('Barcode scanning requires additional libraries (QuaggaJS or ZXing). ' +
                          'This is a placeholder. In production, integrate a barcode scanning library.');
                } catch (err) {
                    alert('Camera access denied or not available');
                    container.style.display = 'none';
                }
            } else {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                container.style.display = 'none';
                scanning = false;
            }
        }

        // Import recipe from URL
        // Show error notification
        function showErrorNotification(message, type = 'error') {
            const notification = document.createElement('div');
            notification.className = 'error-notification ' + type;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // Abort import
        let importAborted = false;
        function abortImport() {
            importAborted = true;
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // Clear search box
        function clearSearch(inputId) {
            document.getElementById(inputId).value = '';
            document.getElementById(inputId).dispatchEvent(new Event('input'));
        }

        // Update search clear button visibility
        function updateSearchClearButton(inputId, clearBtnId) {
            const input = document.getElementById(inputId);
            const btn = document.getElementById(clearBtnId);
            if (input.value.trim()) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        }

        // Cancel cocktail edit
        function cancelCocktailEdit() {
            clearCocktailForm();
            editingCocktailId = null;
            
            // Switch to cocktails tab
            switchTab('cocktails');
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.nav-tab[onclick*=\"cocktails\"]').classList.add('active');
        }

        async function importRecipe() {
            const url = document.getElementById('importUrl').value.trim();
            if (!url) {
                showErrorNotification('Please enter a recipe URL');
                return;
            }

            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showErrorNotification('Please enter a valid URL starting with http:// or https://');
                return;
            }

            importAborted = false;
            document.getElementById('loadingOverlay').classList.add('active');
            
            try {
                // Fetch the webpage content
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `Please fetch and analyze this cocktail recipe URL: ${url}

Extract the following information and return it as a JSON object:
- name: cocktail name
- category: one of (Classic, Modern, Refreshing, Bitter, Sweet, Sour, Tropical)
- baseSpirit: primary alcohol (Vodka, Gin, Rum, Tequila, Whiskey, Bourbon, Brandy, Mezcal, Other)
- ingredients: array of objects with {name, amount}
- steps: array of instruction strings
- source: the URL
- image: image URL if found, otherwise null

Return ONLY the JSON object, no other text.`
                        }],
                        tools: [{
                            type: 'web_search_20250305',
                            name: 'web_search'
                        }]
                    })
                });

                if (importAborted) return;

                const data = await response.json();
                
                // Extract text from response
                let recipeText = '';
                if (data.content) {
                    for (const item of data.content) {
                        if (item.type === 'text') {
                            recipeText += item.text;
                        }
                    }
                }

                // Try to parse JSON from the response
                const jsonMatch = recipeText.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('Could not extract recipe data');
                }

                const recipe = JSON.parse(jsonMatch[0]);

                // Fill in the form
                if (recipe.name) document.getElementById('cocktailName').value = recipe.name;
                if (recipe.category) document.getElementById('cocktailCategory').value = recipe.category;
                if (recipe.baseSpirit) document.getElementById('cocktailSpirit').value = recipe.baseSpirit;
                if (recipe.source) document.getElementById('cocktailSource').value = recipe.source;
                if (recipe.image) document.getElementById('cocktailImage').value = recipe.image;

                // Fill ingredients
                if (recipe.ingredients && recipe.ingredients.length > 0) {
                    const ingredientsContainer = document.getElementById('ingredientsContainer');
                    ingredientsContainer.innerHTML = '';
                    recipe.ingredients.forEach(ing => {
                        const row = document.createElement('div');
                        row.className = 'form-row ingredient-row';
                        row.innerHTML = `
                            <input type="text" class="form-input" placeholder="Ingredient name" data-ingredient-name value="${ing.name || ''}">
                            <input type="number" class="form-input" placeholder="Qty" data-ingredient-amount style="max-width: 80px;" value="${ing.amount || ''}">
                            <select class="form-select ingredient-unit" data-ingredient-unit>
                                <option value="">Unit</option>
                                <option value="oz">oz</option>
                                <option value="ml">ml</option>
                                <option value="cl">cl</option>
                                <option value="dash">dash</option>
                                <option value="splash">splash</option>
                                <option value="drop">drop</option>
                                <option value="tsp">tsp</option>
                                <option value="tbsp">tbsp</option>
                                <option value="wedge">wedge</option>
                                <option value="piece">piece</option>
                            </select>
                            <button class="btn btn-remove" onclick="removeIngredientRow(this)">âœ•</button>
                        `;
                        ingredientsContainer.appendChild(row);
                    });
                }

                // Fill steps
                if (recipe.steps && recipe.steps.length > 0) {
                    const stepsContainer = document.getElementById('stepsContainer');
                    stepsContainer.innerHTML = '';
                    recipe.steps.forEach(step => {
                        const row = document.createElement('div');
                        row.className = 'form-row step-row';
                        row.innerHTML = `
                            <input type="text" class="form-input" placeholder="Step description" data-step style="flex: 1;" value="${step}">
                            <button class="btn btn-remove" onclick="removeStepRow(this)">âœ•</button>
                        `;
                        stepsContainer.appendChild(row);
                    });
                }

                document.getElementById('loadingOverlay').classList.remove('active');
                showErrorNotification('Recipe imported successfully!', 'success');

            } catch (error) {
                console.error('Import error:', error);
                document.getElementById('loadingOverlay').classList.remove('active');
                showErrorNotification('Failed to import recipe: ' + error.message);
            }
        }

        // Randomize cocktail color
        function randomizeColor() {
            const randomColor = cocktailColors[Math.floor(Math.random() * cocktailColors.length)];
            document.getElementById('cocktailColor').value = randomColor;
        }

        // Use spirit color based on selected base spirit
        function useSpiritColor() {
            const baseSpirit = document.getElementById('cocktailSpirit').value;
            if (!baseSpirit) {
                showErrorNotification('Please select a base spirit first');
                return;
            }
            const color = spiritColors[baseSpirit] || spiritColors['Other'];
            document.getElementById('cocktailColor').value = color;
        }

        // Toggle filters
        function toggleFilters() {
            const content = document.getElementById('filterContent');
            const btn = event.target.closest('.filter-toggle-btn');
            content.classList.toggle('show');
            btn.classList.toggle('active');
        }

        // Toggle inventory filters
        function toggleInventoryFilters() {
            const content = document.getElementById('inventoryFilterContent');
            const btn = event.target.closest('.filter-toggle-btn');
            content.classList.toggle('show');
            btn.classList.toggle('active');
        }

        // Show add cocktail form
        let editingCocktailId = null;

        function showAddCocktailForm() {
            editingCocktailId = null;
            clearCocktailForm();
            switchTab('add-cocktail');
            // Manually update active tab
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('cocktails-section').style.display = 'none';
            document.getElementById('add-cocktail-section').classList.add('active');
            document.getElementById('inventory-section').classList.remove('active');
            
            // Update form title
            document.querySelector('#add-cocktail-section h2').textContent = 'Create New Cocktail';
        }

        // Edit cocktail
        function editCocktail(cocktailId) {
            const cocktail = cocktails.find(c => c.id === cocktailId);
            if (!cocktail) return;

            editingCocktailId = cocktailId;

            // Switch to add-cocktail section
            document.getElementById('cocktails-section').style.display = 'none';
            document.getElementById('add-cocktail-section').classList.add('active');
            document.getElementById('inventory-section').classList.remove('active');
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

            // Update form title
            document.querySelector('#add-cocktail-section h2').textContent = 'Edit Cocktail';

            // Populate form
            document.getElementById('cocktailName').value = cocktail.name;
            document.getElementById('cocktailImage').value = cocktail.image || '';
            document.getElementById('cocktailCategory').value = cocktail.category;
            document.getElementById('cocktailSpirit').value = cocktail.baseSpirit;
            document.getElementById('cocktailSource').value = cocktail.source;
            document.getElementById('cocktailColor').value = cocktail.color || spiritColors[cocktail.baseSpirit] || spiritColors['Other'];

            // Populate ingredients
            const ingredientsContainer = document.getElementById('ingredientsContainer');
            ingredientsContainer.innerHTML = '';
            cocktail.ingredients.forEach(ing => {
                const row = document.createElement('div');
                row.className = 'form-row ingredient-row';
                row.innerHTML = `
                    <input type="text" class="form-input" placeholder="Ingredient name" data-ingredient-name value="${ing.name}">
                    <input type="number" class="form-input" placeholder="Qty" data-ingredient-amount style="max-width: 80px;" value="${ing.amount}">
                    <select class="form-select ingredient-unit" data-ingredient-unit>
                        <option value="">Unit</option>
                        <option value="oz" ${ing.unit === 'oz' ? 'selected' : ''}>oz</option>
                        <option value="ml" ${ing.unit === 'ml' ? 'selected' : ''}>ml</option>
                        <option value="cl" ${ing.unit === 'cl' ? 'selected' : ''}>cl</option>
                        <option value="dash" ${ing.unit === 'dash' ? 'selected' : ''}>dash</option>
                        <option value="splash" ${ing.unit === 'splash' ? 'selected' : ''}>splash</option>
                        <option value="drop" ${ing.unit === 'drop' ? 'selected' : ''}>drop</option>
                        <option value="tsp" ${ing.unit === 'tsp' ? 'selected' : ''}>tsp</option>
                        <option value="tbsp" ${ing.unit === 'tbsp' ? 'selected' : ''}>tbsp</option>
                        <option value="wedge" ${ing.unit === 'wedge' ? 'selected' : ''}>wedge</option>
                        <option value="piece" ${ing.unit === 'piece' ? 'selected' : ''}>piece</option>
                    </select>
                    <button class="btn btn-remove" onclick="removeIngredientRow(this)">âœ•</button>
                `;
                ingredientsContainer.appendChild(row);
            });

            // Populate steps
            const stepsContainer = document.getElementById('stepsContainer');
            stepsContainer.innerHTML = '';
            cocktail.steps.forEach(step => {
                const row = document.createElement('div');
                row.className = 'form-row step-row';
                row.innerHTML = `
                    <input type="text" class="form-input" placeholder="Step description" data-step style="flex: 1;" value="${step}">
                    <button class="btn btn-remove" onclick="removeStepRow(this)">âœ•</button>
                `;
                stepsContainer.appendChild(row);
            });

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Render inventory filters
        function renderInventoryFilters() {
            // Category filters
            const categories = [...new Set(barInventory.map(i => i.category).filter(c => c))];
            const categoryContainer = document.getElementById('inventoryCategoryFilters');
            categoryContainer.innerHTML = `
                <button class="filter-btn ${!inventoryFilters.category ? 'active' : ''}" onclick="setInventoryFilter('category', null)">All</button>
                ${categories.map(cat => 
                    `<button class="filter-btn ${inventoryFilters.category === cat ? 'active' : ''}" onclick="setInventoryFilter('category', '${cat}')">${cat}</button>`
                ).join('')}
            `;

            // Brand filters
            const brands = [...new Set(barInventory.map(i => i.brand).filter(b => b))];
            const brandContainer = document.getElementById('inventoryBrandFilters');
            if (brands.length > 0) {
                brandContainer.innerHTML = `
                    <button class="filter-btn ${!inventoryFilters.brand ? 'active' : ''}" onclick="setInventoryFilter('brand', null)">All</button>
                    ${brands.map(brand => 
                        `<button class="filter-btn ${inventoryFilters.brand === brand ? 'active' : ''}" onclick="setInventoryFilter('brand', '${brand}')">${brand}</button>`
                    ).join('')}
                `;
            } else {
                brandContainer.innerHTML = '<p style="color: var(--text-light); font-size: 0.9rem;">No brands added yet</p>';
            }
        }

        // Set inventory filter
        function setInventoryFilter(type, value) {
            inventoryFilters[type] = value;
            renderInventoryFilters();
            renderInventory();
        }

        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        // Add ingredient row
        function addIngredientRow() {
            const container = document.getElementById('ingredientsContainer');
            const row = document.createElement('div');
            row.className = 'form-row ingredient-row';
            row.innerHTML = `
                <input type="text" class="form-input" placeholder="Ingredient name" data-ingredient-name>
                <input type="number" class="form-input" placeholder="Qty" data-ingredient-amount style="max-width: 80px;">
                <select class="form-select ingredient-unit" data-ingredient-unit>
                    <option value="">Unit</option>
                    <option value="oz">oz</option>
                    <option value="ml">ml</option>
                    <option value="cl">cl</option>
                    <option value="dash">dash</option>
                    <option value="splash">splash</option>
                    <option value="drop">drop</option>
                    <option value="tsp">tsp</option>
                    <option value="tbsp">tbsp</option>
                    <option value="wedge">wedge</option>
                    <option value="piece">piece</option>
                </select>
                <button class="btn btn-remove" onclick="removeIngredientRow(this)">âœ•</button>
            `;
            container.appendChild(row);
        }

        // Remove ingredient row
        function removeIngredientRow(button) {
            const container = document.getElementById('ingredientsContainer');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }

        // Add step row
        function addStepRow() {
            const container = document.getElementById('stepsContainer');
            const row = document.createElement('div');
            row.className = 'form-row step-row';
            row.innerHTML = `
                <input type="text" class="form-input" placeholder="Step description" data-step style="flex: 1;">
                <button class="btn btn-remove" onclick="removeStepRow(this)">âœ•</button>
            `;
            container.appendChild(row);
        }

        // Remove step row
        function removeStepRow(button) {
            const container = document.getElementById('stepsContainer');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }

        // Clear cocktail form
        function clearCocktailForm() {
            document.getElementById('importUrl').value = '';
            document.getElementById('cocktailName').value = '';
            document.getElementById('cocktailImage').value = '';
            document.getElementById('cocktailCategory').value = '';
            document.getElementById('cocktailSpirit').value = '';
            document.getElementById('cocktailSource').value = '';
            document.getElementById('cocktailColor').value = spiritColors['Vodka'];
            
            // Reset to one ingredient row
            const ingredientsContainer = document.getElementById('ingredientsContainer');
            ingredientsContainer.innerHTML = `
                <div class="form-row ingredient-row">
                    <input type="text" class="form-input" placeholder="Ingredient name" data-ingredient-name>
                    <input type="number" class="form-input" placeholder="Qty" data-ingredient-amount style="max-width: 80px;">
                    <select class="form-select ingredient-unit" data-ingredient-unit>
                        <option value="">Unit</option>
                        <option value="oz">oz</option>
                        <option value="ml">ml</option>
                        <option value="cl">cl</option>
                        <option value="dash">dash</option>
                        <option value="splash">splash</option>
                        <option value="drop">drop</option>
                        <option value="tsp">tsp</option>
                        <option value="tbsp">tbsp</option>
                        <option value="wedge">wedge</option>
                        <option value="piece">piece</option>
                    </select>
                    <button class="btn btn-remove" onclick="removeIngredientRow(this)">âœ•</button>
                </div>
            `;
            
            // Reset to one step row
            const stepsContainer = document.getElementById('stepsContainer');
            stepsContainer.innerHTML = `
                <div class="form-row step-row">
                    <input type="text" class="form-input" placeholder="Step description" data-step style="flex: 1;">
                    <button class="btn btn-remove" onclick="removeStepRow(this)">âœ•</button>
                </div>
            `;
        }

        // Save cocktail
        function saveCocktail() {
            const name = document.getElementById('cocktailName').value.trim();
            const image = document.getElementById('cocktailImage').value.trim();
            const category = document.getElementById('cocktailCategory').value;
            const baseSpirit = document.getElementById('cocktailSpirit').value;
            const source = document.getElementById('cocktailSource').value.trim() || 'User Created';
            const color = document.getElementById('cocktailColor').value;

            if (!name || !category || !baseSpirit) {
                showErrorNotification('Please fill in cocktail name, category, and base spirit');
                return;
            }

            // Get ingredients
            const ingredientRows = document.querySelectorAll('.ingredient-row');
            const ingredients = [];
            ingredientRows.forEach(row => {
                const nameInput = row.querySelector('[data-ingredient-name]');
                const amountInput = row.querySelector('[data-ingredient-amount]');
                const unitInput = row.querySelector('[data-ingredient-unit]');
                if (nameInput.value.trim() && amountInput.value.trim()) {
                    ingredients.push({
                        name: nameInput.value.trim(),
                        amount: amountInput.value.trim(),
                        unit: unitInput.value || ''
                    });
                }
            });

            if (ingredients.length === 0) {
                showErrorNotification('Please add at least one ingredient');
                return;
            }

            // Get steps
            const stepRows = document.querySelectorAll('.step-row');
            const steps = [];
            stepRows.forEach(row => {
                const stepInput = row.querySelector('[data-step]');
                if (stepInput.value.trim()) {
                    steps.push(stepInput.value.trim());
                }
            });

            if (steps.length === 0) {
                showErrorNotification('Please add at least one instruction step');
                return;
            }

            if (editingCocktailId !== null) {
                // Edit existing cocktail
                const index = cocktails.findIndex(c => c.id === editingCocktailId);
                if (index !== -1) {
                    cocktails[index] = {
                        ...cocktails[index],
                        name,
                        category,
                        baseSpirit,
                        image: image || null,
                        color: color,
                        ingredients,
                        steps,
                        source
                    };
                    localStorage.setItem('cocktails', JSON.stringify(cocktails));
                    showErrorNotification(`Cocktail "${name}" updated successfully!`, 'success');
                }
            } else {
                // Create new cocktail
                const newCocktail = {
                    id: Math.max(...cocktails.map(c => c.id), 0) + 1,
                    name,
                    category,
                    baseSpirit,
                    image: image || null,
                    color: color || spiritColors[baseSpirit] || spiritColors['Other'],
                    ingredients,
                    steps,
                    source
                };

                cocktails.push(newCocktail);
                localStorage.setItem('cocktails', JSON.stringify(cocktails));
                showErrorNotification(`Cocktail "${name}" created successfully!`, 'success');
            }

            // Clear form and switch to cocktails view
            clearCocktailForm();
            editingCocktailId = null;
            
            // Update filters and render
            renderFilters();
            renderCocktails();
            
            // Switch to cocktails tab
            switchTab('cocktails');
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab')[0].classList.add('active');
        }

        // Close modal on outside click
        document.getElementById('cocktailModal').addEventListener('click', (e) => {
            if (e.target.id === 'cocktailModal') {
                closeModal();
            }
        });

        // Initialize app
        loadTheme();
        init();
    </script>
</body>
</html>
